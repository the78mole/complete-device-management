# telegraf.conf – CDM Provider Stack
#
# Collects health metrics from provider-stack services and infrastructure.
# Writes all data to InfluxDB on the provider stack.
#
# hawkBit and ThingsBoard are NOT part of the provider-stack; they live in the
# tenant-stack.  This config focuses on platform service health so the
# operations team has visibility into Keycloak, RabbitMQ, step-ca, Grafana and
# the IoT Bridge API.
#
# Environment variables (set in docker-compose.yml):
#   INFLUX_URL        – InfluxDB HTTP URL  (e.g. http://influxdb:8086)
#   INFLUX_TOKEN      – InfluxDB operator token
#   INFLUX_ORG        – InfluxDB organisation  (cdm-org)
#   INFLUX_BUCKET     – InfluxDB bucket  (iot-metrics)

[global_tags]
  component = "provider"

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "10s"
  flush_interval = "30s"
  flush_jitter = "10s"
  precision = ""
  quiet = false
  omit_hostname = true

# ── Outputs ───────────────────────────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls          = ["$INFLUX_URL"]
  token         = "$INFLUX_TOKEN"
  organization  = "$INFLUX_ORG"
  bucket        = "$INFLUX_BUCKET"
  timeout       = "15s"
  content_encoding = "gzip"

# ── Provider service health checks ───────────────────────────────────────────
# Polls HTTP health/status endpoints for all provider-stack services.
# Stored as `http_response` measurements with a `service` tag.

[[inputs.http_response]]
  urls = [
    "http://keycloak:8080/auth/health/live",
    "http://grafana:3000/api/health",
    "http://iot-bridge-api:8000/health",
  ]
  response_timeout = "10s"
  method = "GET"
  [inputs.http_response.tags]
    category = "service-health"

# RabbitMQ health-check needs Basic Auth and the /rabbitmq path prefix
[[inputs.http_response]]
  urls = ["http://rabbitmq:15672/rabbitmq/api/healthchecks/node"]
  response_timeout = "10s"
  method = "GET"
  username = "$RABBITMQ_ADMIN_USER"
  password = "$RABBITMQ_ADMIN_PASS"
  [inputs.http_response.tags]
    category = "service-health"

[[inputs.http_response]]
  urls = ["https://step-ca:9000/health"]
  response_timeout = "10s"
  method = "GET"
  tls_ca = "/etc/ssl/certs/ca-certificates.crt"
  insecure_skip_verify = true
  [inputs.http_response.tags]
    category = "service-health"

# ── RabbitMQ management metrics ───────────────────────────────────────────────
# Native RabbitMQ plugin metrics (queue depths, message rates, connection counts).
# management.path_prefix = /rabbitmq applies on port 15672 too
[[inputs.rabbitmq]]
  url      = "http://rabbitmq:15672/rabbitmq"
  username = "$RABBITMQ_ADMIN_USER"
  password = "$RABBITMQ_ADMIN_PASS"
  # Note: 404 errors for /api/federation-links are expected – the
  # rabbitmq_federation plugin is not enabled. They are non-fatal.

# ── InfluxDB internal metrics ─────────────────────────────────────────────────
[[inputs.influxdb_v2_listener]]
  # Receives /metrics push from InfluxDB 2.x internal telemetry feed
  service_address = ":8186"

# ── Optional: MQTT telemetry from cdm-metrics vHost ──────────────────────────
# Subscribes to the cdm-metrics virtual host on the central RabbitMQ broker
# for any platform-level telemetry that services may publish.
# Disabled at startup if no publisher is active; set startup_error_behavior=retry.

# [[inputs.mqtt_consumer]]
#   # Disabled: the OAuth2 auth backend (priority 1) causes RabbitMQ to reject
#   # plain username/password credentials over MQTT before the internal backend
#   # can handle the fallthrough, which crashes Telegraf with a fatal auth error.
#   # Re-enable once a dedicated MQTT service account (non-OAuth2) is created,
#   # or once RabbitMQ plain-auth fallthrough via MQTT is confirmed working.
#   servers   = ["tcp://rabbitmq:1883"]
#   topics    = ["cdm/provider/#"]
#   qos       = 1
#   client_id = "telegraf-provider"
#   username  = "$RABBITMQ_ADMIN_USER"
#   password  = "$RABBITMQ_ADMIN_PASS"
#   data_format = "json"
#   name_override = "provider_telemetry"
#   startup_error_behavior = "retry"
