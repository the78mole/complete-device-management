# RabbitMQ configuration for CDM Provider Stack
#
# Serve the management UI under /rabbitmq/ so the Caddy reverse proxy
# can route traffic to it without path-stripping.
management.path_prefix = /rabbitmq

# Load pre-defined vHosts and users from definitions file at startup
load_definitions = /etc/rabbitmq/definitions.json

# ── MQTT plugin ──────────────────────────────────────────────────────────────
mqtt.listeners.tcp.default = 1883
mqtt.listeners.ssl.default = 8883
mqtt.allow_anonymous        = false
# Map the client certificate CN to the RabbitMQ MQTT username (EXTERNAL auth)
mqtt.ssl_cert_login_from    = common_name

# ── TLS (server certificate issued by Provider step-ca) ──────────────────────
# The rabbitmq-cert-init service populates /etc/rabbitmq/tls/ before RabbitMQ
# starts.
ssl_options.cacertfile             = /etc/rabbitmq/tls/ca.crt
ssl_options.certfile               = /etc/rabbitmq/tls/server.crt
ssl_options.keyfile                = /etc/rabbitmq/tls/server.key
ssl_options.verify                 = verify_peer
ssl_options.fail_if_no_peer_cert   = true

# ── Auth mechanisms ───────────────────────────────────────────────────────────
# PLAIN / AMQPLAIN for admin UI & management API
# EXTERNAL maps the client certificate CN to the RabbitMQ username – used by
# Tenant MQTT bridges (the CN is "{tenant_id}-mqtt-bridge").
auth_mechanisms.1 = PLAIN
auth_mechanisms.2 = AMQPLAIN
auth_mechanisms.3 = EXTERNAL
ssl_cert_login_from = common_name
