# telegraf.conf – CDM Tenant Stack
#
# Collects service health and operational metrics from all tenant-stack services.
# Writes to InfluxDB on the local tenant stack.
# Optionally forwards aggregated device metrics to the Provider RabbitMQ vHost.
#
# Environment variables (set in docker-compose.yml):
#   INFLUX_URL                – InfluxDB HTTP URL  (http://influxdb:8086)
#   INFLUX_TOKEN              – InfluxDB operator token
#   INFLUX_ORG                – InfluxDB organisation  (${TENANT_ID}-org)
#   INFLUX_BUCKET             – InfluxDB bucket  (device-telemetry)
#   HAWKBIT_URL               – hawkBit base URL  (http://hawkbit:8070/hawkbit)
#   HAWKBIT_USER              – hawkBit admin user
#   HAWKBIT_PASSWORD          – hawkBit admin password
#   THINGSBOARD_HOST          – ThingsBoard hostname  (thingsboard)
#   TENANT_ID                 – Tenant identifier tag
#   PROVIDER_RABBITMQ_URL     – (optional) amqp URL on Provider RabbitMQ
#   PROVIDER_RABBITMQ_USER    – (optional) Provider RabbitMQ user
#   PROVIDER_RABBITMQ_PASSWORD – (optional) Provider RabbitMQ password

[global_tags]
  tenant    = "$TENANT_ID"
  component = "tenant"

[agent]
  interval          = "60s"
  round_interval    = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "10s"
  flush_interval    = "30s"
  flush_jitter      = "10s"
  precision         = ""
  quiet             = false
  omit_hostname     = true

# ── Outputs ───────────────────────────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls         = ["$INFLUX_URL"]
  token        = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket       = "$INFLUX_BUCKET"
  timeout      = "15s"
  content_encoding = "gzip"

# ── Tenant service health checks ──────────────────────────────────────────────

[[inputs.http_response]]
  urls = [
    "http://keycloak:8080/auth/health/live",
    "http://grafana:3000/api/health",
    "http://iot-bridge-api:8000/health",
    "http://thingsboard:9090/login",
    "http://hawkbit:8070/hawkbit",
  ]
  response_timeout = "10s"
  method           = "GET"
  [inputs.http_response.tags]
    category = "service-health"

[[inputs.http_response]]
  urls = ["https://step-ca:9000/health"]
  response_timeout    = "10s"
  method              = "GET"
  insecure_skip_verify = true
  [inputs.http_response.tags]
    category = "service-health"

# ── hawkBit OTA metrics ───────────────────────────────────────────────────────
# Polls the hawkBit management REST API for target and rollout counts.
[[inputs.http_response]]
  urls = [
    "$HAWKBIT_URL/rest/v1/targets?limit=1",
    "$HAWKBIT_URL/rest/v1/rollouts?limit=1",
    "$HAWKBIT_URL/rest/v1/distributionsets?limit=1",
  ]
  response_timeout = "10s"
  method           = "GET"
  username         = "$HAWKBIT_USER"
  password         = "$HAWKBIT_PASSWORD"
  [inputs.http_response.tags]
    category = "hawkbit"

# ── hawkBit / DMF RabbitMQ internal metrics ───────────────────────────────────
[[inputs.rabbitmq]]
  url      = "http://hawkbit-rmq:15672"
  username = "$HAWKBIT_RMQ_USER"
  password = "$HAWKBIT_RMQ_PASSWORD"
  [inputs.rabbitmq.tags]
    component = "hawkbit-rmq"

# ── InfluxDB internal metrics ─────────────────────────────────────────────────
[[inputs.influxdb_v2_listener]]
  service_address = ":8186"

# ── Optional: forward metrics to Provider RabbitMQ ──────────────────────────
# Uncomment and set PROVIDER_RABBITMQ_* env vars to enable.
# This allows the Provider-Stack to aggregate cross-tenant metrics.
#
# [[outputs.amqp]]
#   brokers  = ["$PROVIDER_RABBITMQ_URL"]
#   exchange = "cdm-metrics"
#   routing_tag    = "tenant"
#   delivery_mode  = "persistent"
#   timeout  = "5s"
#   username = "$PROVIDER_RABBITMQ_USER"
#   password = "$PROVIDER_RABBITMQ_PASSWORD"
#   [outputs.amqp.tags]
#     source = "tenant"
