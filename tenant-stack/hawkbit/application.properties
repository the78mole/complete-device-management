# hawkBit Update Server – application.properties (Tenant Stack)
# Mounted read-only into the container at /opt/hawkbit/application.properties
#
# Runtime placeholders (${VAR:?msg}) are resolved by Spring Boot from the
# container environment as set in docker-compose.yml.

# ─── Server ───────────────────────────────────────────────────────────────────
server.port=8070
server.servlet.context-path=/hawkbit

# ─── Database (MySQL) ────────────────────────────────────────────────────────
spring.datasource.url=jdbc:mysql://hawkbit-db:3306/hawkbit?useInformationSchema=true
spring.datasource.username=hawkbit
spring.datasource.password=${HB_DB_PASSWORD:?HB_DB_PASSWORD must be set}
spring.datasource.hikari.connection-timeout=30000
spring.jpa.hibernate.ddl-auto=update

# ─── RabbitMQ (internal DMF event bus – hawkBit-only RabbitMQ) ──────────────
# Note: this is the DEDICATED per-tenant RabbitMQ for the hawkBit DMF bus only.
# It is NOT the Provider-Stack RabbitMQ.
spring.rabbitmq.host=${SPRING_RABBITMQ_HOST:-hawkbit-rmq}
spring.rabbitmq.port=${SPRING_RABBITMQ_PORT:-5672}
spring.rabbitmq.username=${SPRING_RABBITMQ_USERNAME:-admin}
spring.rabbitmq.password=${SPRING_RABBITMQ_PASSWORD:?SPRING_RABBITMQ_PASSWORD must be set}
spring.rabbitmq.virtualHost=/

# ─── Artifact Storage ─────────────────────────────────────────────────────────
org.eclipse.hawkbit.repository.file.path=/data/artifacts

# ─── Security – anonymous access disabled ────────────────────────────────────
hawkbit.server.security.anonymous.enabled=false

# ─── Security – DDI API (device polling) ─────────────────────────────────────
# Devices authenticate using a per-target Security Token sent in the
# Authorization header.  Tokens are generated per-target inside hawkBit.
hawkbit.server.security.dos.filter.enabled=true
hawkbit.server.security.dos.maxStatusEntriesPerAction=1000
hawkbit.server.security.dos.maxAttributeEntriesPerTarget=100
hawkbit.server.security.dos.maxActionsPerTarget=4000

# ─── Keycloak OIDC for the Management UI ─────────────────────────────────────
# The issuer URI points to the TENANT realm (not the provider 'cdm' realm).
# Both the browser-facing (UI login) and server-to-server (token exchange)
# calls use the internal Docker hostname so oauth works within the compose net.
spring.security.oauth2.client.registration.keycloak.client-id=hawkbit
spring.security.oauth2.client.registration.keycloak.client-secret=${HB_OIDC_SECRET:?HB_OIDC_SECRET must be set}
spring.security.oauth2.client.registration.keycloak.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.keycloak.scope=openid,profile,email,roles

# issuer-uri uses the internal Keycloak hostname; TENANT_ID is substituted by
# Spring Boot's property placeholder from the container environment.
spring.security.oauth2.client.provider.keycloak.issuer-uri=http://keycloak:8080/auth/realms/${TENANT_ID:-tenant}

# ─── Polling intervals ────────────────────────────────────────────────────────
hawkbit.controller.pollingTime=00:01:00
hawkbit.controller.minPollingTime=00:00:30

# ─── Logging ─────────────────────────────────────────────────────────────────
logging.level.org.eclipse.hawkbit=INFO
logging.level.org.springframework.security=WARN
