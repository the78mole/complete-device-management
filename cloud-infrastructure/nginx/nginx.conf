# CDM Nginx Reverse Proxy
#
# A single entry point (port 8888) that routes all services by path prefix.
# In Codespaces this maps to https://<codespace>-8888.app.github.dev/
# Locally: http://localhost:8888/
#
# Path mapping:
#   /               → Landing page   (static HTML with service links)
#   /auth/          → Keycloak       :8080  (already uses /auth prefix)
#   /grafana/       → Grafana        :3000  (GF_SERVER_SERVE_FROM_SUB_PATH=true)
#   /hawkbit/       → hawkBit        :8070  (SERVER_SERVLET_CONTEXT_PATH=/hawkbit)
#   /api/           → IoT Bridge API :8000  (FastAPI root_path=/api)
#   /terminal/      → Terminal Proxy :8090  (WebSocket upgrade)
#   /pki/           → step-ca        :9000  (PKI API, HTTPS upstream)
#   /rabbitmq/      → RabbitMQ Mgmt  :15672 (management.path_prefix=/rabbitmq)
#
# InfluxDB UI is NOT proxied here: the embedded SPA uses webpack-hashed
# JS bundles with absolute paths that cannot be rewritten via sub_filter.
# The landing page links directly to port 8086 using a JS helper.

worker_processes  auto;
error_log         /var/log/nginx/error.log warn;
pid               /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout 65;

    # ── Proxy-Header-Auflösung ──────────────────────────────────────────
    # Codespaces-Proxy setzt X-Forwarded-Host = externe öffentliche Domain
    # und X-Forwarded-Proto = https, liefert aber Host = localhost:<port>.
    # Diese map-Direktiven reichen die Codespaces-Werte durch statt sie
    # mit nginx-eigenen Werten zu überschreiben.
    # Lokal (ohne Codespaces): keine X-Forwarded-* vorhanden → Fallback auf
    # $http_host und $scheme.
    map $http_x_forwarded_host $real_host {
        ""      $http_host;
        default $http_x_forwarded_host;
    }

    map $http_x_forwarded_proto $real_proto {
        ""      $scheme;
        default $http_x_forwarded_proto;
    }

    proxy_set_header  Host              $real_host;
    proxy_set_header  X-Real-IP         $remote_addr;
    proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header  X-Forwarded-Proto $real_proto;
    proxy_set_header  X-Forwarded-Host  $real_host;
    # X-Forwarded-Port wird NICHT gesetzt:
    # - Lokal: der Port steckt bereits im Host-Header (localhost:8888)
    # - Codespaces HTTPS: Keycloak leitet korrekt https:// ohne Port ab (443 std.)
    proxy_http_version 1.1;

    # Allow large firmware uploads for hawkBit OTA artifacts
    client_max_body_size 512m;

    # ── Upstream definitions ─────────────────────────────────────────────
    upstream keycloak      { server keycloak:8080;       }
    upstream grafana       { server grafana:3000;        }
    upstream hawkbit       { server hawkbit:8070;        }
    upstream iot_bridge    { server iot-bridge-api:8000; }
    upstream terminal      { server terminal-proxy:8090; }
    upstream step_ca       { server step-ca:9000;        }
    upstream rabbitmq_mgmt { server rabbitmq:15672;      }

    server {
        listen 8888;
        server_name _;

        # Landing page – static HTML served directly by nginx
        root /usr/share/nginx/html;
        index index.html;

        # ── Keycloak (/auth/) ────────────────────────────────────────────
        location /auth/ {
            proxy_pass http://keycloak/auth/;
            # Keycloak issues its own Location redirects with the internal port.
            # Rewrite them to the external host ($real_host = Codespaces hostname
            # or localhost:8888 for local use).
            proxy_redirect ~^https?://[^/]+(:\d+)?(/auth/.*)$ $real_proto://$real_host$2;
        }

        # ── Grafana (/grafana/) ──────────────────────────────────────────
        location /grafana/ {
            proxy_pass http://grafana/grafana/;
            proxy_redirect off;
        }

        # ── hawkBit (/hawkbit/) ──────────────────────────────────────────
        location /hawkbit/ {
            proxy_pass http://hawkbit/hawkbit/;
            proxy_redirect off;
            # Needed for SSE (Server-Sent Events) used by hawkBit UI
            proxy_buffering off;
            proxy_read_timeout 3600s;
        }

        # ── IoT Bridge API (/api/) ───────────────────────────────────────
        location /api/ {
            # FastAPI serves internally at / (root_path=/api only affects OpenAPI schema)
            proxy_pass http://iot_bridge/;
            proxy_redirect off;
        }

        # ── Terminal Proxy (/terminal/) – WebSocket ──────────────────────
        location /terminal/ {
            proxy_pass http://terminal/;
            # WebSocket upgrade headers
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        # ── step-ca PKI API (/pki/) ──────────────────────────────────────
        # step-ca is a pure HTTPS API – there is no web UI.
        # Useful endpoints: GET /pki/health  GET /pki/root/<fingerprint>
        location /pki/ {
            proxy_pass       https://step_ca/;
            proxy_ssl_verify off;  # step-ca root CA not in nginx trust store
            proxy_redirect   off;
        }

        # ── RabbitMQ Management UI (/rabbitmq/) ──────────────────────────
        # Requires rabbitmq:3-management-alpine image.
        # management.path_prefix = /rabbitmq (rabbitmq/rabbitmq.conf) makes
        # the plugin serve all assets and API calls under /rabbitmq/.
        location /rabbitmq/ {
            proxy_pass   http://rabbitmq_mgmt/rabbitmq/;
            proxy_redirect off;
        }

        # ── Landing page (/index.html) ─────────────────────────────────
        location = / {
            try_files /index.html =404;
        }
    }
}
