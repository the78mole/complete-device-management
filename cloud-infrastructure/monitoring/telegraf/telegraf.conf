# telegraf.conf – CDM Cloud Infrastructure
#
# Collects device metrics from hawkBit and ThingsBoard as the authoritative
# cloud-side sources.  Direct device-OS metric collection is intentionally
# absent: the edge device no longer pushes raw system stats; instead metrics
# are surfaced from the management plane (hawkBit OTA status) and the
# data plane (ThingsBoard device telemetry via the iot-bridge-api webhook).
#
# Optional: subscribes to a tenant-scoped MQTT topic for additional sensor
# data that devices may publish independently of ThingsBoard.
#
# Mandanten-Isolation (tenant isolation):
#   – hawkBit targets are polled per-tenant and tagged with HAWKBIT_TENANT.
#   – MQTT topics follow cdm/<tenant>/<device>/sensors so each tenant's
#     data is physically separated at the broker level.
#   – All InfluxDB writes include tenant_id and device_id tags so Grafana
#     dashboards can filter by tenant with a simple label selector.
#
# Environment variables (set in docker-compose.yml):
#   INFLUX_URL        – InfluxDB HTTP URL
#   INFLUX_TOKEN      – InfluxDB operator token
#   INFLUX_ORG        – InfluxDB organisation
#   INFLUX_BUCKET     – InfluxDB bucket
#   HAWKBIT_URL       – hawkBit Management UI base URL
#   HAWKBIT_USER      – hawkBit admin username
#   HAWKBIT_PASSWORD  – hawkBit admin password
#   HAWKBIT_TENANT    – hawkBit tenant identifier (e.g. DEFAULT)
#   THINGSBOARD_HOST  – ThingsBoard hostname (for MQTT broker)

[global_tags]
  tenant_id = "$HAWKBIT_TENANT"
  component = "cloud"

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "10s"
  flush_interval = "30s"
  flush_jitter = "10s"
  precision = ""
  quiet = false
  omit_hostname = true

# ── Outputs ───────────────────────────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls          = ["$INFLUX_URL"]
  token         = "$INFLUX_TOKEN"
  organization  = "$INFLUX_ORG"
  bucket        = "$INFLUX_BUCKET"
  timeout       = "15s"
  content_encoding = "gzip"

# ── hawkBit: target / OTA status metrics ─────────────────────────────────────
# Polls the hawkBit Management REST API for all registered targets and their
# current OTA update status.  This gives the operations team a consolidated
# view of firmware rollout progress per tenant.
#
# hawkBit REST GET /rest/v1/targets returns a paginated list; we request a
# large page (500) to cover all devices in a single call for small fleets.
# For larger fleets, run multiple Telegraf instances with filtered queries.

[[inputs.http]]
  urls    = ["$HAWKBIT_URL/rest/v1/targets?limit=500&sort=name:ASC"]
  method  = "GET"
  timeout = "20s"
  interval = "60s"
  name_override = "hawkbit_targets"

  # Basic-auth credentials for the hawkBit Management REST API
  username = "$HAWKBIT_USER"
  password = "$HAWKBIT_PASSWORD"

  # Parse the JSON array of targets from the "content" key
  data_format = "json_v2"
  [[inputs.http.json_v2]]
    [[inputs.http.json_v2.object]]
      path = "content"
      # Tags are low-cardinality string fields; remaining keys become fields
      tags = ["controllerId", "updateStatus"]
      [[inputs.http.json_v2.object.field]]
        path = "lastControllerRequestAt"
        type = "int"
        optional = true
      [[inputs.http.json_v2.object.field]]
        path = "installedAt"
        type = "int"
        optional = true
      [[inputs.http.json_v2.object.field]]
        path = "createdAt"
        type = "int"
        optional = true

# ── Optional: additional MQTT sensor data ─────────────────────────────────────
# Subscribes to the tenant-scoped topic for any extra sensor readings that
# devices publish outside of the standard ThingsBoard telemetry path.
#
# Topic pattern: cdm/<tenant>/<device>/sensors
#   cdm/+/+/sensors matches all tenants and devices, but each device
#   connects with its own X.509 certificate so cross-tenant publishing
#   is prevented at the broker level.
#
# NOTE: This input is dormant unless devices actively publish to these topics.
# Set servers to the ThingsBoard MQTT host and configure credentials if
# ThingsBoard enforces authentication on port 1883 in your environment.

[[inputs.mqtt_consumer]]
  servers     = ["tcp://$THINGSBOARD_HOST:1883"]
  topics      = ["cdm/+/+/sensors"]
  qos         = 1
  client_id   = "telegraf-cloud-$HAWKBIT_TENANT"
  data_format = "json"
  name_override = "device_sensors"
  # Extract tenant_id and device_id from the topic segments for isolation tags
  topic_tag   = "mqtt_topic"
  tag_keys    = ["sensor_id", "sensor_type"]
  # Do not crash if the broker is temporarily unavailable at startup
  # (e.g. ThingsBoard still booting); keep retrying in the background.
  startup_error_behavior = "retry"
