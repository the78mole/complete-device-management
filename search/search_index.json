{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Complete Device Management","text":"<p>Complete Device Management is an enterprise-grade, open-source IoT Device &amp; Software Lifecycle Management Platform \u2014 a fully self-hosted alternative to commercial solutions such as Mender.io Enterprise.</p> <p>It combines best-in-class open-source components into a cohesive, Zero-Trust platform that covers the entire device lifecycle:</p> <ul> <li>Zero-Touch Provisioning \u2014 devices enroll automatically using X.509 certificates signed by a private CA.</li> <li>Secure OTA Updates \u2014 Eclipse hawkBit manages software campaigns; RAUC executes A/B OS updates on the device.</li> <li>Remote Troubleshooting \u2014 WireGuard VPN + browser-based <code>ttyd</code> terminal embedded directly in the management UI.</li> <li>High-Frequency Telemetry \u2014 Telegraf streams metrics to InfluxDB; Grafana visualises them.</li> <li>Single Sign-On \u2014 Keycloak provides OIDC/SAML authentication across all services.</li> </ul>"},{"location":"#technology-stack","title":"Technology Stack","text":"Layer Component Role IAM Keycloak OIDC/SAML SSO IoT Platform ThingsBoard CE Device registry, MQTT, Rule Engine, UI OTA Backend Eclipse hawkBit Software campaign management PKI smallstep step-ca Root CA, device &amp; service cert signing Time-Series DB InfluxDB v2 High-frequency telemetry Visualisation Grafana Dashboards VPN WireGuard Zero-trust device tunnel Web Terminal ttyd + Terminal Proxy Secure browser shell OTA Agent RAUC + rauc-hawkbit-updater A/B OS update execution Metric Agent Telegraf Metric collection &amp; forwarding Glue Services Python FastAPI + Node.js Integration microservices IaC Docker Compose + Helm Local eval + production deploy"},{"location":"#quick-navigation","title":"Quick Navigation","text":"<ul> <li> <p>:material-download: Installation   Prerequisites and step-by-step setup for cloud infrastructure and edge devices.</p> </li> <li> <p>:material-rocket-launch: Getting Started   Enroll your first device and trigger your first OTA update in minutes.</p> </li> <li> <p>:material-sitemap: Architecture   Understand how all components fit together, trust chains, and data flows.</p> </li> <li> <p>:material-cog-transfer: Workflows   Detailed runbooks for provisioning, OTA, remote access, and monitoring.</p> </li> <li> <p>:material-lightbulb: Use Cases   Real-world scenarios including fleet management and incident response.</p> </li> </ul>"},{"location":"#repository-structure","title":"Repository Structure","text":"<pre><code>\u251c\u2500\u2500 .github/\n\u2502   \u251c\u2500\u2500 workflows/          # CI + gh-pages deploy\n\u2502   \u2514\u2500\u2500 ISSUE_TEMPLATE/     # Bug &amp; feature templates\n\u251c\u2500\u2500 cloud-infrastructure/   # All cloud-side service configs &amp; Dockerfiles\n\u251c\u2500\u2500 glue-services/\n\u2502   \u251c\u2500\u2500 iot-bridge-api/     # FastAPI: PKI enrollment, TB webhook, WireGuard allocation\n\u2502   \u2514\u2500\u2500 terminal-proxy/     # Node.js: JWT-validated WebSocket \u2192 ttyd proxy\n\u251c\u2500\u2500 device-stack/           # Edge device simulation (Docker Compose)\n\u2514\u2500\u2500 docs/                   # This documentation (MkDocs source)\n</code></pre>"},{"location":"#licence","title":"Licence","text":"<p>MIT \u00a9 the78mole contributors</p>"},{"location":"architecture/","title":"Architecture Overview","text":"<p>Complete Device Management is built around five integration pillars:</p> <ol> <li>Identity &amp; Trust \u2014 Keycloak (SSO) + step-ca (PKI) establish who can connect and which certificates are trusted.</li> <li>Device Communication \u2014 ThingsBoard provides the MQTT broker and the single-pane-of-glass UI.</li> <li>Software Updates \u2014 hawkBit manages campaigns; RAUC executes them atomically on the device.</li> <li>Observability \u2014 InfluxDB stores high-frequency metrics; Grafana visualises them.</li> <li>Remote Access \u2014 WireGuard creates a secure overlay network; ttyd + terminal-proxy deliver a browser shell.</li> </ol>"},{"location":"architecture/#high-level-diagram","title":"High-Level Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Cloud Infrastructure                                                            \u2502\n\u2502                                                                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  OIDC/SAML  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  REST  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502 Keycloak \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502   ThingsBoard    \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502     hawkBit        \u2502    \u2502\n\u2502  \u2502  (IAM)   \u2502             \u2502  (UI/MQTT Broker)\u2502        \u2502  (OTA Campaigns)   \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                    \u2502 Rule Engine fires on device connect         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  alloc  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 step-ca  \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502  IoT Bridge API  \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502  WireGuard Server \u2502   \u2502\n\u2502  \u2502  (PKI)   \u2502  sign CSR   \u2502  (FastAPI glue)  \u2502  peer   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                  \u2502\n\u2502                                                                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  \u2502\n\u2502  \u2502 InfluxDB \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502    Telegraf       \u2502  (metrics from device)          \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                  \u2502\n\u2502         \u2502                                                                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  \u2502\n\u2502  \u2502 Grafana  \u2502             \u2502 Terminal Proxy   \u2502  WS + JWT validation             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u25b2 MQTT TLS (8883)           \u2502 WS \u2192 WireGuard IP \u2192 ttyd                   \n         \u2502                           \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Edge Device (Linux / Yocto / Docker simulation)                              \u2502\n\u2502                                                                                \u2502\n\u2502  bootstrap (step-cli enroll)                                                  \u2502\n\u2502      \u2193                                                                         \u2502\n\u2502  wireguard-client  \u2190\u2192  mqtt-client  \u2190\u2192  telegraf  \u2190\u2192  rauc-updater  \u2190\u2192  ttyd \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#component-interactions","title":"Component Interactions","text":""},{"location":"architecture/#enrollment-flow","title":"Enrollment Flow","text":"<pre><code>Device                     IoT Bridge API              step-ca\n  \u2502\u2500\u2500\u2500 POST /devices/{id}/enroll (CSR) \u2500\u2500\u25ba\u2502                \u2502\n  \u2502                                        \u2502\u2500\u2500\u2500 sign CSR \u2500\u2500\u25ba\u2502\n  \u2502                                        \u2502\u25c4\u2500\u2500 cert \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n  \u2502\u25c4\u2500\u2500 cert + CA chain + WG config \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                \u2502\n  \u2502                                        \u2502\u2500\u2500 create hawkBit target\n  \u2502                                        \u2502\u2500\u2500 allocate WireGuard IP\n</code></pre>"},{"location":"architecture/#mqtt-connect-flow","title":"MQTT Connect Flow","text":"<pre><code>Device                       ThingsBoard                  IoT Bridge API\n  \u2502\u2500\u2500 MQTT CONNECT (mTLS) \u2500\u2500\u25ba\u2502                                   \u2502\n  \u2502                           \u2502\u2500\u2500 Rule Engine: POST_CONNECT \u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n  \u2502                           \u2502              webhook              \u2502\u2500\u2500 verify device exists\n  \u2502                           \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 200 OK \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n  \u2502\u25c4\u2500\u2500 CONNACK \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n</code></pre>"},{"location":"architecture/#data-segregation","title":"Data Segregation","text":"Data Type Transport Storage Device state, alarms, OTA status MQTT \u2192 ThingsBoard ThingsBoard PostgreSQL High-frequency metrics (CPU/RAM/disk) Telegraf \u2192 InfluxDB directly InfluxDB Audit / access logs Keycloak events Keycloak DB <p>This design keeps ThingsBoard's database lean by offloading high-cardinality metric streams to InfluxDB.</p>"},{"location":"architecture/#security-zones","title":"Security Zones","text":"<pre><code>Internet (untrusted)\n    \u2502\n    \u25bc\n[ Reverse Proxy / Firewall ]  \u2190 expose only 443 (HTTPS), 8883 (MQTTS), 51820/udp (WireGuard)\n    \u2502\n    \u25bc\nManagement Network (docker internal)\n    \u251c\u2500\u2500 Keycloak\n    \u251c\u2500\u2500 ThingsBoard\n    \u251c\u2500\u2500 hawkBit\n    \u251c\u2500\u2500 Grafana (no direct internet exposure \u2014 embedded via iframe)\n    \u251c\u2500\u2500 iot-bridge-api\n    \u2514\u2500\u2500 terminal-proxy\n\nDevice VPN Network (10.8.0.0/24 WireGuard)\n    \u251c\u2500\u2500 WireGuard server (10.8.0.1)\n    \u2514\u2500\u2500 Devices (10.8.0.2 ... 10.8.0.254) \u2014 only reachable via VPN\n</code></pre>"},{"location":"architecture/data-flow/","title":"Data Flow","text":"<p>This page describes how data moves through the platform for the three main flows: telemetry, OTA updates, and remote access.</p>"},{"location":"architecture/data-flow/#1-telemetry-flow","title":"1. Telemetry Flow","text":"<pre><code>Device\n  \u251c\u2500[Telegraf]\u2500\u2500 CPU/RAM/disk/net metrics \u2500\u2500HTTP\u2500\u2500\u25ba InfluxDB \u2500\u2500\u25ba Grafana dashboards\n  \u2514\u2500[MQTT client]\u2500\u2500 device state, alarms, OTA status \u2500\u2500MQTTS\u2500\u2500\u25ba ThingsBoard\n                                                                    \u2514\u2500\u2500 Rule Engine\n                                                                          \u2514\u2500\u2500 alarms, notifications\n</code></pre> <p>Why two paths?</p> <ul> <li>ThingsBoard MQTT handles business-logic telemetry (low frequency, device state changes, alarm conditions). ThingsBoard's rule engine can trigger actions based on this data.</li> <li>Telegraf \u2192 InfluxDB handles high-frequency performance metrics (sampled every 10 seconds or faster). This avoids overwhelming ThingsBoard's PostgreSQL backend.</li> </ul>"},{"location":"architecture/data-flow/#mqtt-message-format","title":"MQTT Message Format","text":"<p>ThingsBoard expects telemetry on topic <code>v1/devices/me/telemetry</code>:</p> <pre><code>{\n  \"cpu_usage\": 23.4,\n  \"mem_free_mb\": 512,\n  \"sw_version\": \"1.0.0\",\n  \"rauc_slot\": \"B\",\n  \"ota_status\": \"idle\"\n}\n</code></pre>"},{"location":"architecture/data-flow/#2-ota-update-flow","title":"2. OTA Update Flow","text":"<pre><code>Operator (hawkBit UI)\n  \u2514\u2500\u2500 creates Distribution Set + Rollout\n          \u2502\n          \u25bc\n      hawkBit \u2500\u2500DDI poll (every 30s)\u2500\u2500\u25ba Device rauc-hawkbit-updater\n                                              \u2502\n                                         downloads artefact\n                                              \u2502\n                                         rauc install (inactive slot)\n                                              \u2502\n                                         reboot into new slot\n                                              \u2502\n                                         reports success \u2500\u2500\u25ba hawkBit\n                                              \u2502\n                                         MQTT publish \u2500\u2500\u25ba ThingsBoard (sw_version, rauc_slot)\n</code></pre>"},{"location":"architecture/data-flow/#3-remote-access-flow","title":"3. Remote Access Flow","text":"<pre><code>Browser (ThingsBoard UI)\n  \u2514\u2500\u2500 Terminal Widget opens WebSocket to:\n        wss://terminal-proxy:8888/terminal?deviceId=device-001&amp;token=&lt;Keycloak JWT&gt;\n              \u2502\n        terminal-proxy validates JWT (Keycloak JWKS)\n              \u2502\n        resolves device-001 \u2192 WireGuard IP (10.8.0.2)\n              \u2502\n        proxies WebSocket to:\n              http://10.8.0.2:7681 (ttyd on device via WireGuard VPN)\n              \u2502\n        ttyd spawns /bin/bash in a PTY\n              \u2502\n        keystrokes/output flow bidirectionally through the chain\n</code></pre>"},{"location":"architecture/data-flow/#4-enrollment-flow-one-time","title":"4. Enrollment Flow (one-time)","text":"<pre><code>Device bootstrap\n  1. step crypto key pair \u2192 device.key (stays on device)\n  2. step certificate create \u2192 device.csr\n  3. POST /devices/{id}/enroll (CSR) \u2192 iot-bridge-api\n        \u251c\u2500\u2500 step-ca JWK provisioner issues OTT\n        \u251c\u2500\u2500 POST /1.0/sign \u2192 step-ca\n        \u251c\u2500\u2500 allocates WireGuard IP (10.8.0.x)\n        \u2514\u2500\u2500 returns: cert + CA chain + WireGuard config\n  4. Device saves cert, applies WireGuard config\n  5. Device connects MQTT with mTLS\n  6. ThingsBoard Rule Engine fires POST_CONNECT webhook \u2192 iot-bridge-api\n        \u251c\u2500\u2500 creates hawkBit target\n        \u2514\u2500\u2500 records device metadata\n</code></pre>"},{"location":"architecture/data-flow/#network-diagram","title":"Network Diagram","text":"<pre><code>                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502       Docker Internal Network        \u2502\n                    \u2502        172.20.0.0/16                 \u2502\n                    \u2502                                      \u2502\n  Browser  \u25008080\u2500\u2500\u25ba \u2502 ThingsBoard \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n  Browser  \u25008180\u2500\u2500\u25ba \u2502 Keycloak                         \u2502  \u2502\n  Browser  \u25003000\u2500\u2500\u25ba \u2502 Grafana \u25c4\u2500\u2500 InfluxDB \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502  \u2502\n  Browser  \u25008090\u2500\u2500\u25ba \u2502 hawkBit                         \u2502\u2502  \u2502\n                    \u2502 iot-bridge-api                  \u2502\u2502  \u2502\n                    \u2502 terminal-proxy \u25008888\u2500\u2500\u25ba Browser \u2502\u2502  \u2502\n                    \u2502 step-ca \u25009000                   \u2502\u2502  \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u253c\u2500\u2500\u2518\n                                                      \u2502\u2502\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u253c\u2500\u2500\u2510\n                    \u2502   WireGuard VPN 10.8.0.0/24     \u2502\u2502  \u2502\n                    \u2502                                 \u2502\u2502  \u2502\n                    \u2502 WireGuard server (10.8.0.1) \u2500\u2500\u2500\u2500\u2518\u2502  \u2502\n                    \u2502         \u2502                        \u2502  \u2502\n  Device \u2500UDP 51820\u2500\u2524   Device (10.8.0.2)             \u2502  \u2502\n          MQTTS 8883\u2500\u2524    \u251c\u2500\u2500 Telegraf \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                    \u2502    \u251c\u2500\u2500 ttyd :7681                    \u2502\n                    \u2502    \u2514\u2500\u2500 rauc-hawkbit-updater          \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2518\n</code></pre>"},{"location":"architecture/iam/","title":"Identity &amp; Access Management \u2014 Keycloak","text":"<p>Keycloak is the central Identity Provider (IdP) for the entire platform. All user-facing services delegate authentication to Keycloak via OpenID Connect (OIDC).</p>"},{"location":"architecture/iam/#realm-structure","title":"Realm Structure","text":"<p>A dedicated realm named <code>cdm</code> is pre-configured with:</p> <ul> <li>OIDC Clients: <code>thingsboard</code>, <code>hawkbit</code>, <code>grafana</code></li> <li>Default Roles: <code>cdm-admin</code>, <code>cdm-operator</code>, <code>cdm-viewer</code></li> <li>Password Policy: min 12 characters, no dictionary words</li> <li>Session Timeout: 8 hours (access token 5 minutes, refresh token 30 minutes)</li> </ul> <p>The realm export is at <code>cloud-infrastructure/keycloak/realm-export.json</code>. It is imported automatically on first boot via <code>docker-entrypoint.sh</code>.</p>"},{"location":"architecture/iam/#oidc-client-configuration","title":"OIDC Client Configuration","text":""},{"location":"architecture/iam/#thingsboard","title":"ThingsBoard","text":"Setting Value Client ID <code>thingsboard</code> Client Protocol <code>openid-connect</code> Access Type <code>confidential</code> Valid Redirect URIs <code>http://localhost:8080/*</code> Roles mapped to TB roles <code>cdm-admin</code> \u2192 <code>TENANT_ADMIN</code>; <code>cdm-operator</code> \u2192 <code>CUSTOMER_USER</code>"},{"location":"architecture/iam/#hawkbit","title":"hawkBit","text":"Setting Value Client ID <code>hawkbit</code> Access Type <code>confidential</code> Valid Redirect URIs <code>http://localhost:8090/*</code>"},{"location":"architecture/iam/#grafana","title":"Grafana","text":"Setting Value Client ID <code>grafana</code> Access Type <code>confidential</code> Valid Redirect URIs <code>http://localhost:3000/*</code>"},{"location":"architecture/iam/#role-based-access","title":"Role-Based Access","text":"Role ThingsBoard hawkBit Grafana <code>cdm-admin</code> Tenant Admin Full access Admin <code>cdm-operator</code> Customer User Read + trigger deployments Editor <code>cdm-viewer</code> Read-only Read-only Viewer"},{"location":"architecture/iam/#updating-client-secrets","title":"Updating Client Secrets","text":"<p>After the first boot, Keycloak generates new client secrets. Retrieve them:</p> <ol> <li>Log in to Keycloak admin: http://localhost:8180 \u2192 <code>cdm</code> realm \u2192 Clients.</li> <li>For each client (<code>thingsboard</code>, <code>hawkbit</code>, <code>grafana</code>), go to Credentials \u2192 copy the Secret.</li> <li>Update <code>.env</code>:    <pre><code>TB_KEYCLOAK_CLIENT_SECRET=&lt;thingsboard secret&gt;\nHAWKBIT_KEYCLOAK_CLIENT_SECRET=&lt;hawkbit secret&gt;\nGRAFANA_KEYCLOAK_CLIENT_SECRET=&lt;grafana secret&gt;\n</code></pre></li> <li>Restart the affected services:    <pre><code>docker compose restart thingsboard hawkbit grafana\n</code></pre></li> </ol>"},{"location":"architecture/iam/#multi-tenancy","title":"Multi-Tenancy","text":"<p>The <code>tenant-sync-service</code> (part of <code>iot-bridge-api</code>) listens to Keycloak events. When a new organisation is created in Keycloak, it automatically:</p> <ol> <li>Creates a matching Tenant in ThingsBoard.</li> <li>Creates a matching Organisation in Grafana.</li> <li>Creates a hawkBit tenant group (if hawkBit PE multi-tenancy is enabled).</li> </ol> <p>Endpoint: <code>POST /webhooks/keycloak/tenant-created</code> in <code>iot-bridge-api</code>.</p>"},{"location":"architecture/iam/#security-considerations","title":"Security Considerations","text":"<p>Default Admin Password</p> <p>Change <code>KEYCLOAK_ADMIN_PASSWORD</code> in <code>.env</code> before exposing Keycloak to any network.</p> <p>Brute-Force Protection</p> <p>Enable Keycloak's built-in brute-force detection: Realm Settings \u2192 Security Defenses \u2192 Brute Force Detection.</p> <p>HTTPS in Production</p> <p>In production, place Keycloak behind a TLS-terminating reverse proxy. Update all <code>Valid Redirect URIs</code> to <code>https://</code>.</p>"},{"location":"architecture/pki/","title":"PKI \u2014 smallstep step-ca","text":"<p>The platform uses smallstep step-ca as its private Certificate Authority. This page describes the trust hierarchy, certificate profiles, and operational procedures.</p>"},{"location":"architecture/pki/#trust-hierarchy","title":"Trust Hierarchy","text":"<pre><code>Root CA  (offline-safe, self-signed, 10-year validity)\n    \u2514\u2500\u2500 Intermediate CA  (online, used for all signing, 5-year validity)\n            \u251c\u2500\u2500 Service Certificates  (serverAuth + clientAuth, 1-year)\n            \u2514\u2500\u2500 Device Certificates  (clientAuth only, configurable TTL)\n</code></pre> <p>The Root CA private key is encrypted with <code>STEP_CA_PASSWORD</code> and stored in the <code>step-ca-data</code> Docker volume. In production, move the Root CA key offline after generating the Intermediate CA.</p>"},{"location":"architecture/pki/#provisioners","title":"Provisioners","text":"<p>Two provisioners are configured out of the box:</p> Name Type Purpose <code>iot-bridge</code> JWK (JSON Web Key) Used by <code>iot-bridge-api</code> to sign device CSRs programmatically <code>acme</code> ACME Used by internal services to auto-renew TLS certificates via the ACME protocol"},{"location":"architecture/pki/#jwk-provisioner-flow","title":"JWK Provisioner Flow","text":"<pre><code>iot-bridge-api\n  1. Fetches provisioner list from step-ca API\n  2. Finds the `iot-bridge` JWK provisioner\n  3. Decrypts the provisioner private key using STEP_CA_PROVISIONER_PASSWORD\n  4. Creates a one-time token (OTT) JWT signed with the provisioner key\n  5. POSTs the CSR + OTT to step-ca /1.0/sign\n  6. Returns the signed certificate to the device\n</code></pre>"},{"location":"architecture/pki/#certificate-templates","title":"Certificate Templates","text":""},{"location":"architecture/pki/#device-leaf-templatesdevice-leaftpl","title":"Device Leaf (<code>templates/device-leaf.tpl</code>)","text":"<ul> <li>Key Usage: <code>digitalSignature</code></li> <li>Extended Key Usage: <code>clientAuth</code> only (devices cannot act as servers)</li> <li>Subject: <code>CN=&lt;device_id&gt;</code></li> <li>SAN: <code>&lt;device_id&gt;</code> (DNS)</li> <li>No CA flag</li> </ul>"},{"location":"architecture/pki/#service-leaf-templatesservice-leaftpl","title":"Service Leaf (<code>templates/service-leaf.tpl</code>)","text":"<ul> <li>Key Usage: <code>digitalSignature</code>, <code>keyEncipherment</code></li> <li>Extended Key Usage: <code>serverAuth</code> + <code>clientAuth</code></li> <li>Subject: <code>CN=&lt;service_name&gt;</code></li> <li>SAN: configurable DNS names + IPs</li> </ul>"},{"location":"architecture/pki/#operational-procedures","title":"Operational Procedures","text":""},{"location":"architecture/pki/#retrieve-the-root-ca-certificate","title":"Retrieve the Root CA Certificate","text":"<pre><code># From the running container\ndocker compose exec step-ca step ca root\n\n# Save to file\ndocker compose exec step-ca step ca root /tmp/root_ca.crt\ndocker compose cp step-ca:/tmp/root_ca.crt ./root_ca.crt\n</code></pre>"},{"location":"architecture/pki/#retrieve-the-ca-fingerprint","title":"Retrieve the CA Fingerprint","text":"<pre><code>step certificate fingerprint root_ca.crt\n</code></pre> <p>Set this value as <code>STEP_CA_FINGERPRINT</code> in both <code>.env</code> files.</p>"},{"location":"architecture/pki/#inspect-a-device-certificate","title":"Inspect a Device Certificate","text":"<pre><code>step certificate inspect device.crt\n</code></pre>"},{"location":"architecture/pki/#revoke-a-device-certificate","title":"Revoke a Device Certificate","text":"<pre><code>step ca revoke --cert device.crt --key device.key \\\n  --ca-url https://localhost:9000 --root root_ca.crt\n</code></pre> <p>After revocation, the certificate will be rejected at the next MQTT reconnect (ThingsBoard validates against the CRL/OCSP endpoint).</p>"},{"location":"architecture/pki/#rotate-the-intermediate-ca","title":"Rotate the Intermediate CA","text":"<pre><code># Generate a new intermediate key and CSR\nstep certificate create \"CDM Intermediate CA 2\" intermediate2.csr intermediate2.key \\\n  --ca root_ca.crt --ca-key root_ca.key --profile intermediate-ca --no-password --insecure\n\n# Sign with Root CA\nstep certificate sign intermediate2.csr root_ca.crt root_ca.key\n\n# Replace in step-ca \u2014 see smallstep docs for hot rotation\n</code></pre>"},{"location":"architecture/pki/#security-considerations","title":"Security Considerations","text":"<p>Root CA Key</p> <p>In production, after generating the Intermediate CA, export the Root CA private key from the container, store it offline (HSM or air-gapped vault), and remove it from the <code>step-ca-data</code> volume. Only the Intermediate CA needs to be online.</p> <p>Certificate Validity</p> <p>Keep device certificate validity short (hours to days) and rely on automatic renewal. Short-lived certs are more resilient to key compromise than long-lived ones.</p>"},{"location":"getting-started/","title":"Quickstart","text":"<p>This guide gets you from zero to a working device enrolled in the platform, sending telemetry, in under 20 minutes.</p>"},{"location":"getting-started/#what-you-will-build","title":"What You Will Build","text":"<pre><code>step-ca (Root CA)\n    \u2514\u2500\u2500 signs device certificate\n            \u2514\u2500\u2500 device MQTT client  \u2500\u2500TLS\u2500\u2500\u25ba  ThingsBoard  \u2500\u2500Rule Engine\u2500\u2500\u25ba  iot-bridge-api\n                                                                                    \u251c\u2500\u2500 hawkBit target created\n                                                                                    \u2514\u2500\u2500 WireGuard IP allocated\ndevice Telegraf  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba  InfluxDB \u2192 Grafana\n</code></pre>"},{"location":"getting-started/#step-1-start-the-cloud-stack","title":"Step 1 \u2014 Start the Cloud Stack","text":"<pre><code>git clone https://github.com/the78mole/complete-device-management.git\ncd complete-device-management/cloud-infrastructure\ncp .env.example .env\n# Edit .env \u2014 set all *_PASSWORD and STEP_CA_* values\ndocker compose up -d\ndocker compose ps   # wait until all services are healthy\n</code></pre> <p>Full details: Cloud Infrastructure Setup</p>"},{"location":"getting-started/#step-2-bootstrap-thingsboard","title":"Step 2 \u2014 Bootstrap ThingsBoard","text":"<pre><code>docker compose exec thingsboard bash /provision/provision.sh\n</code></pre>"},{"location":"getting-started/#step-3-enroll-your-first-device","title":"Step 3 \u2014 Enroll Your First Device","text":"<pre><code>cd ../device-stack\ncp .env.example .env\n# Edit .env \u2014 set DEVICE_ID=device-001 and point URLs to your cloud host\ndocker compose up\n</code></pre> <p>Watch the <code>bootstrap</code> container log:</p> <pre><code>[enroll] Generating EC P-256 key pair...\n[enroll] Generating CSR for device-001...\n[enroll] Sending CSR to iot-bridge-api...\n[enroll] Certificate received \u2014 saving to /certs/device.crt\n[enroll] WireGuard config saved to /certs/wg0.conf\n[enroll] Done. Exiting cleanly.\n</code></pre> <p>All other services start automatically once enrollment succeeds.</p>"},{"location":"getting-started/#step-4-verify-in-thingsboard","title":"Step 4 \u2014 Verify in ThingsBoard","text":"<ol> <li>Open http://localhost:8080 and log in.</li> <li>Navigate to Devices \u2014 <code>device-001</code> should appear with status Active.</li> <li>Open the device and check the Latest Telemetry tab \u2014 CPU, memory, and disk metrics arrive from Telegraf.</li> </ol>"},{"location":"getting-started/#step-5-view-metrics-in-grafana","title":"Step 5 \u2014 View Metrics in Grafana","text":"<ol> <li>Open http://localhost:3000 (admin / your password from <code>.env</code>).</li> <li>Go to Dashboards \u2192 Device Overview.</li> <li>Select <code>device-001</code> from the device dropdown.</li> </ol>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<ul> <li>Enroll Your First Device (detailed) \u2014 understand every step of the enrollment flow.</li> <li>Trigger Your First OTA Update \u2014 upload a software bundle to hawkBit and deploy it.</li> <li>Remote Access \u2014 open a browser terminal on your device.</li> </ul>"},{"location":"getting-started/first-device/","title":"Enroll Your First Device","text":"<p>This page explains every step of the device enrollment flow in detail, so you understand what happens under the hood.</p>"},{"location":"getting-started/first-device/#overview","title":"Overview","text":"<p>Device enrollment is a one-time process that:</p> <ol> <li>Generates a private key on the device \u2014 the key never leaves the device.</li> <li>Creates a Certificate Signing Request (CSR) and sends it to the <code>iot-bridge-api</code>.</li> <li>The API validates the request and asks <code>step-ca</code> to sign the certificate.</li> <li>The signed certificate and CA chain are returned to the device.</li> <li>The API also generates a WireGuard key pair and peer config for the device.</li> <li>ThingsBoard is notified via its Rule Engine webhook when the device first connects.</li> <li>The <code>iot-bridge-api</code> creates a corresponding target in hawkBit and assigns a static WireGuard IP.</li> </ol>"},{"location":"getting-started/first-device/#manual-enrollment-step-cli","title":"Manual Enrollment (step-cli)","text":"<p>You can perform enrollment manually to understand each step:</p>"},{"location":"getting-started/first-device/#1-generate-a-private-key-and-csr","title":"1. Generate a Private Key and CSR","text":"<pre><code># Install step-cli: https://smallstep.com/docs/step-cli/installation\nstep crypto key pair device.key device.pub --kty EC --curve P-256 --no-password --insecure\nstep certificate create device-001 device.csr device.key \\\n  --csr --san device-001 --no-password --insecure\n</code></pre>"},{"location":"getting-started/first-device/#2-send-the-csr-to-the-bridge-api","title":"2. Send the CSR to the Bridge API","text":"<pre><code>CSR_PEM=$(cat device.csr)\ncurl -s -X POST http://localhost:8000/devices/device-001/enroll \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"csr_pem\\\": \\\"$CSR_PEM\\\"}\" | tee enroll_response.json | python3 -m json.tool\n</code></pre> <p>Expected response:</p> <pre><code>{\n  \"device_id\": \"device-001\",\n  \"certificate_pem\": \"-----BEGIN CERTIFICATE-----\\n...\",\n  \"ca_chain_pem\": \"-----BEGIN CERTIFICATE-----\\n...\",\n  \"wireguard_config\": \"[Interface]\\nPrivateKey = ...\\n...\"\n}\n</code></pre>"},{"location":"getting-started/first-device/#3-save-the-outputs","title":"3. Save the Outputs","text":"<pre><code>python3 -c \"import json,sys; d=json.load(open('enroll_response.json')); \\\n  open('device.crt','w').write(d['certificate_pem']); \\\n  open('ca-chain.crt','w').write(d['ca_chain_pem']); \\\n  open('wg0.conf','w').write(d['wireguard_config'])\"\n</code></pre>"},{"location":"getting-started/first-device/#4-verify-the-certificate","title":"4. Verify the Certificate","text":"<pre><code>openssl x509 -in device.crt -noout -text | grep -A4 \"Subject\\|Issuer\\|Validity\\|Extended Key\"\n</code></pre>"},{"location":"getting-started/first-device/#5-connect-via-mqtt-mtls","title":"5. Connect via MQTT (mTLS)","text":"<pre><code>mosquitto_pub \\\n  --host localhost --port 8883 \\\n  --cafile ca-chain.crt \\\n  --cert device.crt \\\n  --key device.key \\\n  --tls-version tlsv1.2 \\\n  -t \"v1/devices/me/telemetry\" \\\n  -m '{\"test\": 1}'\n</code></pre> <p>If the connection succeeds, the device appears in ThingsBoard immediately.</p>"},{"location":"getting-started/first-device/#automated-enrollment-docker-compose","title":"Automated Enrollment (docker compose)","text":"<p>The <code>device-stack/bootstrap</code> container automates all of the above steps via <code>enroll.sh</code>. It is idempotent \u2014 if <code>/certs/enrolled</code> exists, it skips re-enrollment.</p> <pre><code>cd device-stack\ndocker compose up bootstrap   # runs once and exits with code 0\n</code></pre>"},{"location":"getting-started/first-device/#certificate-renewal","title":"Certificate Renewal","text":"<p>Certificates issued by step-ca have a configurable validity (default: 24 hours for device-leaf certs during development, longer in production). To renew:</p> <pre><code>step ca renew --force device.crt device.key \\\n  --ca-url https://localhost:9000 \\\n  --root ca-chain.crt\n</code></pre> <p>In production, use <code>step-ca</code>'s built-in renewal daemon or a systemd timer.</p>"},{"location":"getting-started/first-device/#revoking-a-certificate","title":"Revoking a Certificate","text":"<p>If a device is decommissioned or compromised:</p> <pre><code>step ca revoke --cert device.crt --key device.key \\\n  --ca-url https://localhost:9000 --root ca-chain.crt\n</code></pre> <p>Then delete the device from ThingsBoard and hawkBit.</p>"},{"location":"getting-started/first-ota-update/","title":"Trigger Your First OTA Update","text":"<p>This guide shows you how to upload a software bundle to hawkBit and deploy it to a device.</p>"},{"location":"getting-started/first-ota-update/#prerequisites","title":"Prerequisites","text":"<ul> <li>The cloud stack is running and ThingsBoard has been bootstrapped.</li> <li>At least one device is enrolled and connected (see Enroll Your First Device).</li> <li>The device's <code>rauc-hawkbit-updater</code> service (or <code>ddi-poll.sh</code> simulation) is running.</li> </ul>"},{"location":"getting-started/first-ota-update/#1-log-in-to-hawkbit","title":"1. Log In to hawkBit","text":"<p>Open http://localhost:8090 in your browser.</p> <p>Default credentials:</p> <ul> <li>Username: <code>admin</code></li> <li>Password: <code>admin</code></li> </ul>"},{"location":"getting-started/first-ota-update/#2-upload-a-software-bundle","title":"2. Upload a Software Bundle","text":"<ol> <li>Go to Upload in the left navigation.</li> <li>Create a new Software Module:</li> <li>Name: <code>cdm-os-image</code></li> <li>Version: <code>1.0.0</code></li> <li>Type: <code>OS</code></li> <li>Upload a bundle file. For testing, you can use any file (the simulation does not check the content).</li> <li>Create a Distribution Set:</li> <li>Name: <code>cdm-release-1.0.0</code></li> <li>Version: <code>1.0.0</code></li> <li>Assign your software module to it.</li> </ol>"},{"location":"getting-started/first-ota-update/#3-create-a-rollout-campaign","title":"3. Create a Rollout Campaign","text":"<ol> <li>Go to Rollout in the left navigation.</li> <li>Click Create Rollout.</li> <li>Fill in:</li> <li>Name: <code>test-rollout-1</code></li> <li>Distribution Set: <code>cdm-release-1.0.0</code></li> <li>Target Filter: <code>name==device-001</code> (or <code>*</code> for all devices)</li> <li>Action Type: <code>Forced</code></li> <li>Groups: 1 group, 100% of targets</li> <li>Click Create and then Start the rollout.</li> </ol>"},{"location":"getting-started/first-ota-update/#4-watch-the-device-receive-and-apply-the-update","title":"4. Watch the Device Receive and Apply the Update","text":"<p>On the device side, the DDI poller (<code>ddi-poll.sh</code> or <code>rauc-hawkbit-updater</code>) checks hawkBit every 30 seconds. When it detects a pending deployment:</p> <pre><code>[ddi-poll] Polling hawkBit DDI...\n[ddi-poll] Deployment action found: action-id=42\n[ddi-poll] Downloading artefacts...\n[ddi-poll] Simulating RAUC install (slot B)...\n[ddi-poll] Reporting success to hawkBit...\n[ddi-poll] Update complete.\n</code></pre> <p>Real Hardware</p> <p>On a real Yocto device with RAUC installed, <code>rauc-hawkbit-updater</code> downloads the bundle and calls <code>rauc install</code> on the inactive A/B partition. After a successful install, the device reboots into the new slot.</p>"},{"location":"getting-started/first-ota-update/#5-verify-the-update-status-in-hawkbit","title":"5. Verify the Update Status in hawkBit","text":"<ol> <li>Go to Deployment in hawkBit.</li> <li>Find <code>device-001</code> \u2014 the status should show Finished: Success.</li> </ol>"},{"location":"getting-started/first-ota-update/#6-verify-the-update-status-in-thingsboard","title":"6. Verify the Update Status in ThingsBoard","text":"<p>The device reports its OTA status back via MQTT. In ThingsBoard:</p> <ol> <li>Open the <code>device-001</code> device.</li> <li>Check Latest Telemetry for the key <code>sw_version</code> \u2014 it should show <code>1.0.0</code>.</li> <li>Check Attributes for <code>rauc_slot</code> \u2014 it should reflect the active boot slot.</li> </ol>"},{"location":"getting-started/first-ota-update/#next-steps","title":"Next Steps","text":"<ul> <li>OTA Updates Workflow \u2014 full rollout strategies, staged rollouts, and rollback.</li> <li>Monitoring \u2014 track update success rates across the fleet in Grafana.</li> </ul>"},{"location":"installation/","title":"Installation Overview","text":"<p>This page lists everything you need before running the platform and points you to the individual setup guides.</p>"},{"location":"installation/#prerequisites","title":"Prerequisites","text":"Requirement Minimum Version Notes Docker 24.x Docker Compose 2.20 Ships with Docker Desktop RAM (cloud stack) 8 GB 16 GB recommended RAM (device simulation) 2 GB Disk (cloud stack) 20 GB free InfluxDB data grows over time OS Linux (amd64) macOS works for development; Windows via WSL 2 <code>git</code> 2.40+ <code>step</code> CLI 0.25+ Required on the host only if you manage certs manually"},{"location":"installation/#installation-paths","title":"Installation Paths","text":""},{"location":"installation/#option-a-local-evaluation-docker-compose","title":"Option A \u2014 Local Evaluation (Docker Compose)","text":"<p>The fastest way to get started. All components run as containers on a single machine.</p> <ol> <li>Cloud Infrastructure setup \u2014 bring up Keycloak, ThingsBoard, hawkBit, step-ca, InfluxDB, Grafana, WireGuard, and the glue services.</li> <li>Device Stack setup \u2014 run a simulated IoT device that enrolls, connects, and sends telemetry.</li> </ol>"},{"location":"installation/#option-b-production-kubernetes","title":"Option B \u2014 Production (Kubernetes)","text":"<p>Kubernetes Helm charts are scaffolded under <code>cloud-infrastructure/helm/</code> (work in progress). Refer to individual component documentation for production hardening advice.</p>"},{"location":"installation/#port-map","title":"Port Map","text":"Service Default Port Protocol ThingsBoard UI 8080 HTTP ThingsBoard MQTT (plain) 1883 MQTT ThingsBoard MQTT (TLS/mTLS) 8883 MQTTS Keycloak 8180 HTTP hawkBit 8090 HTTP InfluxDB 8086 HTTP Grafana 3000 HTTP step-ca 9000 HTTPS iot-bridge-api 8000 HTTP terminal-proxy 8888 HTTP / WS WireGuard 51820 UDP <p>Firewall</p> <p>In production, only expose ports that must be reachable from the internet (e.g., WireGuard UDP and the ThingsBoard MQTT TLS port). All other ports should be behind a reverse proxy or restricted to the internal network.</p>"},{"location":"installation/cloud-infrastructure/","title":"Cloud Infrastructure Setup","text":"<p>This guide walks you through starting all cloud-side services using Docker Compose.</p>"},{"location":"installation/cloud-infrastructure/#1-clone-the-repository","title":"1. Clone the Repository","text":"<pre><code>git clone https://github.com/the78mole/complete-device-management.git\ncd complete-device-management/cloud-infrastructure\n</code></pre>"},{"location":"installation/cloud-infrastructure/#2-configure-environment-variables","title":"2. Configure Environment Variables","text":"<pre><code>cp .env.example .env\n</code></pre> <p>Open <code>.env</code> and set every value marked <code>CHANGE_ME</code>. At a minimum:</p> Variable Description <code>POSTGRES_PASSWORD</code> Password for the shared PostgreSQL instance <code>TB_DB_PASSWORD</code> ThingsBoard's database password <code>KEYCLOAK_ADMIN_PASSWORD</code> Keycloak bootstrap admin password <code>GRAFANA_ADMIN_PASSWORD</code> Grafana admin password <code>INFLUXDB_ADMIN_PASSWORD</code> InfluxDB admin password <code>INFLUXDB_ADMIN_TOKEN</code> InfluxDB API token <code>STEP_CA_PASSWORD</code> step-ca key encryption password <code>STEP_CA_PROVISIONER_PASSWORD</code> Password for the JWK provisioner <p>Secrets</p> <p>Never commit your <code>.env</code> file. It is listed in <code>.gitignore</code>.</p>"},{"location":"installation/cloud-infrastructure/#3-start-the-stack","title":"3. Start the Stack","text":"<pre><code>docker compose up -d\n</code></pre> <p>Services start in dependency order. <code>step-ca</code> initialises first (generates Root CA and Intermediate CA), then all other services start.</p> <p>Check that all containers are healthy:</p> <pre><code>docker compose ps\n</code></pre> <p>Expected output \u2014 every service should show <code>healthy</code> or <code>running</code>:</p> <pre><code>NAME              STATUS\nstep-ca           running (healthy)\npostgres-kc       running (healthy)\nkeycloak          running (healthy)\npostgres-tb       running (healthy)\nthingsboard       running (healthy)\nmysql-hawkbit     running (healthy)\nhawkbit           running (healthy)\ninfluxdb          running (healthy)\ngrafana           running (healthy)\nwireguard         running\niot-bridge-api    running (healthy)\nterminal-proxy    running (healthy)\n</code></pre>"},{"location":"installation/cloud-infrastructure/#4-bootstrap-thingsboard","title":"4. Bootstrap ThingsBoard","text":"<p>After ThingsBoard is healthy, import the rule chain and create the X.509 device profile:</p> <pre><code>docker compose exec thingsboard bash /provision/provision.sh\n</code></pre> <p>This script:</p> <ol> <li>Authenticates with ThingsBoard as the system administrator.</li> <li>Imports <code>cloud-infrastructure/thingsboard/rule-chains/device-provisioning-chain.json</code>.</li> <li>Creates a device profile named <code>cdm-x509</code> with X.509 mTLS authentication, bound to the imported rule chain.</li> </ol>"},{"location":"installation/cloud-infrastructure/#5-retrieve-the-step-ca-root-ca-certificate","title":"5. Retrieve the step-ca Root CA Certificate","text":"<p>Devices and services need to trust the Root CA. Export it with:</p> <pre><code>docker compose exec step-ca step ca root /tmp/root_ca.crt\ndocker compose cp step-ca:/tmp/root_ca.crt ./root_ca.crt\n</code></pre> <p>Copy <code>root_ca.crt</code> to the device stack and to any client machine that needs to verify server certificates.</p>"},{"location":"installation/cloud-infrastructure/#6-configure-single-sign-on","title":"6. Configure Single Sign-On","text":"<p>Keycloak is pre-seeded with a <code>cdm</code> realm containing OIDC clients for ThingsBoard, hawkBit, and Grafana. The realm export is at <code>cloud-infrastructure/keycloak/realm-export.json</code>.</p> <p>After first boot, update the client secrets in the Keycloak admin UI (http://localhost:8180) and copy them into your <code>.env</code>:</p> <pre><code>TB_KEYCLOAK_CLIENT_SECRET=&lt;from Keycloak&gt;\nHAWKBIT_KEYCLOAK_CLIENT_SECRET=&lt;from Keycloak&gt;\nGRAFANA_KEYCLOAK_CLIENT_SECRET=&lt;from Keycloak&gt;\n</code></pre> <p>Then restart the affected services:</p> <pre><code>docker compose restart thingsboard hawkbit grafana\n</code></pre>"},{"location":"installation/cloud-infrastructure/#7-stopping-the-stack","title":"7. Stopping the Stack","text":"<pre><code>docker compose down          # stop containers, keep volumes\ndocker compose down -v       # stop containers AND delete all data (destructive)\n</code></pre>"},{"location":"installation/cloud-infrastructure/#troubleshooting","title":"Troubleshooting","text":"Symptom Likely Cause Fix <code>step-ca</code> exits immediately Missing <code>STEP_CA_PASSWORD</code> Set it in <code>.env</code> ThingsBoard not healthy after 3 min DB not ready <code>docker compose restart thingsboard</code> hawkBit returns 401 Keycloak client secret mismatch Update <code>.env</code> \u2192 restart <code>iot-bridge-api</code> returns 503 on enroll step-ca not reachable Check <code>STEP_CA_URL</code> in <code>.env</code>"},{"location":"installation/device-stack/","title":"Device Stack Setup","text":"<p>The device stack simulates a Linux IoT device using Docker Compose. It models the full edge lifecycle: PKI bootstrapping, WireGuard VPN, MQTT telemetry, OTA polling, and a web terminal.</p>"},{"location":"installation/device-stack/#prerequisites","title":"Prerequisites","text":"<ul> <li>The cloud infrastructure must be running and healthy.</li> <li>The <code>root_ca.crt</code> exported from step-ca must be available (see the cloud setup guide).</li> <li>Docker and Docker Compose installed on the device (or simulation host).</li> </ul>"},{"location":"installation/device-stack/#1-configure-the-device-environment","title":"1. Configure the Device Environment","text":"<pre><code>cd device-stack\ncp .env.example .env\n</code></pre> <p>Key variables to set:</p> Variable Description <code>DEVICE_ID</code> Unique identifier for this device (e.g. <code>device-001</code>) <code>BRIDGE_API_URL</code> URL of the <code>iot-bridge-api</code> (e.g. <code>http://192.168.1.10:8000</code>) <code>STEP_CA_URL</code> URL of step-ca (e.g. <code>https://192.168.1.10:9000</code>) <code>STEP_CA_FINGERPRINT</code> SHA-256 fingerprint of the Root CA \u2014 get it with <code>step certificate fingerprint root_ca.crt</code> <code>TB_MQTT_HOST</code> ThingsBoard MQTT host <code>HAWKBIT_URL</code> hawkBit server URL <code>INFLUXDB_URL</code> InfluxDB URL for Telegraf <code>INFLUXDB_TOKEN</code> InfluxDB write token"},{"location":"installation/device-stack/#2-start-the-device-stack","title":"2. Start the Device Stack","text":"<pre><code>docker compose up\n</code></pre> <p>Boot sequence:</p> <ol> <li>bootstrap (one-shot) \u2014 generates an EC P-256 private key, creates a CSR, calls <code>iot-bridge-api /devices/{id}/enroll</code>, saves the signed certificate, CA chain, and WireGuard config to the shared <code>device-certs</code> volume.</li> <li>All other services start only after <code>bootstrap</code> completes successfully.</li> <li>wireguard-client \u2014 applies the WireGuard config and establishes a tunnel to the cloud.</li> <li>mqtt-client \u2014 publishes simulated telemetry to ThingsBoard using mTLS.</li> <li>telegraf \u2014 streams CPU/memory/disk metrics to InfluxDB.</li> <li>rauc-hawkbit-updater \u2014 polls hawkBit DDI API and simulates RAUC A/B updates.</li> <li>ttyd \u2014 exposes a web terminal on the WireGuard VPN IP, accessible via the terminal-proxy.</li> </ol>"},{"location":"installation/device-stack/#3-verify-enrollment","title":"3. Verify Enrollment","text":"<p>After the <code>bootstrap</code> container exits (code 0), check that the certificate was issued:</p> <pre><code>docker compose exec mqtt-client ls /certs/\n# Expected: device.key  device.crt  ca-chain.crt  wg0.conf\n</code></pre> <p>Check the certificate details:</p> <pre><code>docker compose exec mqtt-client \\\n  openssl x509 -in /certs/device.crt -noout -subject -issuer -dates\n</code></pre>"},{"location":"installation/device-stack/#4-running-on-real-hardware-yocto-linux","title":"4. Running on Real Hardware (Yocto / Linux)","text":"<p>On a real device, replace the Docker simulation with native services:</p> <ol> <li>Install <code>step-cli</code> and run <code>enroll.sh</code> at first boot (e.g. via a systemd one-shot service).</li> <li>Install <code>wireguard-tools</code> and apply the generated <code>wg0.conf</code>.</li> <li>Install <code>telegraf</code> and deploy <code>device-stack/telegraf/telegraf.conf</code>.</li> <li>Install <code>rauc</code> and <code>rauc-hawkbit-updater</code>; deploy <code>device-stack/updater/rauc-hawkbit-updater.conf</code>.</li> <li>Install <code>ttyd</code> using <code>device-stack/terminal/setup.sh</code>.</li> </ol> <p>Refer to <code>device-stack/rauc/system.conf</code> for the reference RAUC A/B slot configuration for a Yocto image.</p>"},{"location":"installation/device-stack/#troubleshooting","title":"Troubleshooting","text":"Symptom Likely Cause Fix <code>bootstrap</code> exits with code 1 <code>BRIDGE_API_URL</code> unreachable Verify the cloud stack is up; check URL in <code>.env</code> <code>bootstrap</code> exits with code 1 step-ca fingerprint mismatch Re-run <code>step certificate fingerprint root_ca.crt</code> and update <code>STEP_CA_FINGERPRINT</code> <code>mqtt-client</code> disconnects immediately ThingsBoard not accepting mTLS Verify the X.509 device profile and that the CA is trusted by ThingsBoard <code>wireguard-client</code> stays in <code>waiting</code> <code>bootstrap</code> did not write <code>wg0.conf</code> Check <code>bootstrap</code> logs"},{"location":"use-cases/","title":"Use Cases Overview","text":"<p>This section describes real-world operational scenarios supported by Complete Device Management.</p>"},{"location":"use-cases/#scenarios","title":"Scenarios","text":"Use Case Description Fleet Management Manage hundreds of devices across multiple tenants \u2014 provisioning, OTA rollouts, monitoring Security Incident Response Revoke compromised certificates, isolate devices, audit access Troubleshooting Diagnose and fix common operational issues"},{"location":"use-cases/#typical-operator-day","title":"Typical Operator Day","text":"<p>A typical day for a fleet operator using this platform:</p> <ol> <li>Morning review \u2014 open Grafana Fleet Summary dashboard; check for devices with high disk or CPU.</li> <li>Firmware rollout \u2014 upload new RAUC bundle to hawkBit, create a staged rollout starting with 5% of the fleet.</li> <li>Remote debug \u2014 use the ThingsBoard Terminal Widget to SSH into a device reporting errors.</li> <li>Alarm triage \u2014 review ThingsBoard alarms; acknowledge resolved ones.</li> <li>Rollout approval \u2014 after canary group succeeds (0 failures, 2 hours stable), expand to 100%.</li> </ol>"},{"location":"use-cases/#multi-tenant-operation","title":"Multi-Tenant Operation","text":"<p>The platform is designed for multi-tenancy from the start:</p> <ul> <li>Each customer is a separate Keycloak realm organisation \u2192 mapped to a ThingsBoard Tenant \u2192 mapped to a Grafana Organisation.</li> <li>The <code>tenant-sync-service</code> in <code>iot-bridge-api</code> automates this mapping.</li> <li>Devices are isolated per tenant \u2014 operators of tenant A cannot see devices of tenant B.</li> <li>hawkBit supports tenant namespacing via the <code>X-Tenant-Id</code> header.</li> </ul>"},{"location":"use-cases/#compliance-audit","title":"Compliance &amp; Audit","text":"<p>The platform generates audit trails at multiple levels:</p> Source What is logged Retention Keycloak Login attempts, role changes, admin actions Keycloak DB (export to SIEM) ThingsBoard Device connect/disconnect, telemetry ingestion ThingsBoard DB iot-bridge-api Enrollment requests, webhook events Application logs step-ca Certificate issuance, revocation step-ca audit log hawkBit Deployment actions, artefact downloads hawkBit DB"},{"location":"use-cases/fleet-management/","title":"Fleet Management","text":"<p>This use case describes how to manage a large fleet of IoT devices across multiple tenants using Complete Device Management.</p>"},{"location":"use-cases/fleet-management/#scenario","title":"Scenario","text":"<p>An industrial equipment manufacturer ships 500 Linux-based controllers to customers across three regions. Each customer is a separate tenant. The manufacturer needs to:</p> <ul> <li>Provision all devices automatically when they first power on at the customer site.</li> <li>Push firmware updates in a controlled, staged manner without disrupting production.</li> <li>Monitor device health in real time.</li> <li>Allow on-call engineers to remotely debug devices without VPN client software on their laptops.</li> </ul>"},{"location":"use-cases/fleet-management/#setup","title":"Setup","text":""},{"location":"use-cases/fleet-management/#1-create-tenants","title":"1. Create Tenants","text":"<p>For each customer, create an organisation in Keycloak:</p> <ol> <li>Log in to Keycloak \u2192 <code>cdm</code> realm \u2192 Groups \u2192 New Group \u2192 <code>customer-a</code>.</li> <li>The <code>tenant-sync-service</code> automatically creates:</li> <li>A ThingsBoard tenant: <code>Customer A</code></li> <li>A Grafana organisation: <code>Customer A</code></li> </ol>"},{"location":"use-cases/fleet-management/#2-assign-operators","title":"2. Assign Operators","text":"<p>Add operator users to the customer group in Keycloak. They receive:</p> <ul> <li><code>cdm-operator</code> role \u2192 ThingsBoard Customer User, hawkBit read + trigger, Grafana Editor.</li> </ul>"},{"location":"use-cases/fleet-management/#3-pre-configure-device-images","title":"3. Pre-configure Device Images","text":"<p>Bake the following into the Yocto OS image before shipping:</p> <pre><code>/opt/cdm/enroll.sh        \u2014 enrollment script\n/opt/cdm/ca-fingerprint   \u2014 step-ca root CA fingerprint\n/etc/cdm/device-config    \u2014 BRIDGE_API_URL, TB_MQTT_HOST, HAWKBIT_URL, INFLUXDB_URL\n</code></pre> <p>The device ID is derived from the hardware serial number at first boot.</p>"},{"location":"use-cases/fleet-management/#day-to-day-operations","title":"Day-to-Day Operations","text":""},{"location":"use-cases/fleet-management/#viewing-the-fleet","title":"Viewing the Fleet","text":"<ol> <li>Open ThingsBoard \u2192 Devices (filter by tenant or device profile <code>cdm-x509</code>).</li> <li>The device list shows:</li> <li>Online/offline status (last activity timestamp)</li> <li>Current firmware version (<code>sw_version</code> attribute)</li> <li>WireGuard IP</li> <li>Active alarm count</li> </ol>"},{"location":"use-cases/fleet-management/#triggering-a-fleet-wide-firmware-update","title":"Triggering a Fleet-Wide Firmware Update","text":"<ol> <li>Build and sign the RAUC bundle in CI/CD.</li> <li>Upload to hawkBit (automate via REST API in your CI pipeline).</li> <li>Create a rollout:</li> <li>Group 1: 5% of devices (canary) \u2014 <code>actionType: soft</code> (device installs at next reboot)</li> <li>Group 2: 25% \u2014 activated after Group 1 reaches 95% success</li> <li>Group 3: 70% \u2014 activated after Group 2 reaches 95% success</li> <li>Monitor in hawkBit Rollout view and Grafana OTA dashboard.</li> </ol>"},{"location":"use-cases/fleet-management/#handling-a-failed-update","title":"Handling a Failed Update","text":"<p>If a device reports <code>ota_status: failure</code>:</p> <ol> <li>ThingsBoard raises an OTA Failure alarm.</li> <li>Operator opens the Terminal Widget and inspects logs:    <pre><code>journalctl -u rauc-hawkbit-updater -n 50\nrauc status\n</code></pre></li> <li>If the bundle was corrupt, re-upload a corrected version and re-trigger the deployment.</li> <li>RAUC automatically reverts to the previous slot after failed boot attempts.</li> </ol>"},{"location":"use-cases/fleet-management/#scaling-considerations","title":"Scaling Considerations","text":"Scale Recommendation &lt; 100 devices Single Docker Compose node is sufficient 100\u20131000 devices Separate DB nodes (managed PostgreSQL, MySQL); keep app containers on Docker Compose &gt; 1000 devices Move to Kubernetes with Helm charts; scale ThingsBoard and InfluxDB horizontally &gt; 10,000 devices Consider ThingsBoard PE (cluster mode), InfluxDB Clustered, and hawkBit cluster"},{"location":"use-cases/security-incident-response/","title":"Security Incident Response","text":"<p>This use case covers how to respond to security incidents \u2014 compromised devices, leaked credentials, and suspicious activity.</p>"},{"location":"use-cases/security-incident-response/#scenario-1-compromised-device-certificate","title":"Scenario 1 \u2014 Compromised Device Certificate","text":"<p>Trigger: A device is physically stolen or its private key is extracted.</p>"},{"location":"use-cases/security-incident-response/#response-steps","title":"Response Steps","text":""},{"location":"use-cases/security-incident-response/#1-revoke-the-certificate-immediately","title":"1. Revoke the Certificate Immediately","text":"<pre><code># From a workstation that trusts the step-ca root\nstep ca revoke \\\n  --cert /path/to/device-001.crt \\\n  --ca-url https://your-step-ca:9000 \\\n  --root root_ca.crt\n</code></pre> <p>If you do not have the certificate file, revoke by serial number:</p> <pre><code>step ca revoke &lt;serial-number&gt; \\\n  --ca-url https://your-step-ca:9000 \\\n  --root root_ca.crt\n</code></pre>"},{"location":"use-cases/security-incident-response/#2-remove-the-wireguard-peer","title":"2. Remove the WireGuard Peer","text":"<pre><code># On the WireGuard server\nwg set wg0 peer &lt;compromised-device-public-key&gt; remove\nwg-quick save wg0\n\n# Remove from cdm_peers.json (in the wg-data volume)\ndocker compose exec iot-bridge-api \\\n  python3 -c \"\nimport json\nwith open('/wg-config/cdm_peers.json') as f: data = json.load(f)\ndata['peers'] = {k:v for k,v in data['peers'].items() if k != 'device-001'}\nwith open('/wg-config/cdm_peers.json','w') as f: json.dump(data, f)\n\"\n</code></pre>"},{"location":"use-cases/security-incident-response/#3-delete-the-device-from-thingsboard","title":"3. Delete the Device from ThingsBoard","text":"<pre><code>curl -X DELETE http://localhost:8080/api/device/&lt;device-id&gt; \\\n  -H \"Authorization: Bearer &lt;admin-jwt&gt;\"\n</code></pre>"},{"location":"use-cases/security-incident-response/#4-delete-the-target-from-hawkbit","title":"4. Delete the Target from hawkBit","text":"<pre><code>curl -X DELETE http://localhost:8090/rest/v1/targets/device-001 \\\n  -u admin:admin\n</code></pre>"},{"location":"use-cases/security-incident-response/#5-issue-a-new-certificate-for-the-replacement-device","title":"5. Issue a New Certificate for the Replacement Device","text":"<p>Follow the Device Provisioning Workflow with a new <code>DEVICE_ID</code>.</p>"},{"location":"use-cases/security-incident-response/#scenario-2-leaked-influxdb-token","title":"Scenario 2 \u2014 Leaked InfluxDB Token","text":"<p>Trigger: An InfluxDB write token is accidentally exposed in logs or a git commit.</p>"},{"location":"use-cases/security-incident-response/#response-steps_1","title":"Response Steps","text":"<ol> <li>Log in to InfluxDB (http://localhost:8086).</li> <li>Go to Load Data \u2192 API Tokens.</li> <li>Find the compromised token and click Delete.</li> <li>Create a new token with the same permissions.</li> <li>Update <code>INFLUXDB_TOKEN</code> in <code>.env</code> and restart Telegraf on all devices.</li> </ol>"},{"location":"use-cases/security-incident-response/#scenario-3-suspicious-mqtt-traffic","title":"Scenario 3 \u2014 Suspicious MQTT Traffic","text":"<p>Trigger: A device is sending unexpected telemetry topics or unusual payloads.</p>"},{"location":"use-cases/security-incident-response/#investigation","title":"Investigation","text":"<ol> <li>In ThingsBoard, open the device \u2192 Latest Telemetry \u2014 check for unexpected keys.</li> <li>Enable Rule Chain debug mode to inspect raw MQTT messages.</li> <li>If the behaviour is confirmed malicious, revoke the certificate (Scenario 1).</li> </ol>"},{"location":"use-cases/security-incident-response/#prevention","title":"Prevention","text":"<ul> <li>Use ThingsBoard MQTT topic filtering to reject unexpected topics at the broker level.</li> <li>Enable ThingsBoard's rate limiting per device to detect flooding attacks.</li> </ul>"},{"location":"use-cases/security-incident-response/#scenario-4-keycloak-admin-credential-compromise","title":"Scenario 4 \u2014 Keycloak Admin Credential Compromise","text":"<p>Trigger: The Keycloak admin password is leaked.</p>"},{"location":"use-cases/security-incident-response/#response-steps_2","title":"Response Steps","text":"<ol> <li>Immediately change the admin password via the Keycloak admin CLI:    <pre><code>docker compose exec keycloak \\\n  /opt/keycloak/bin/kcadm.sh set-password \\\n  --target-realm master --username admin --new-password &lt;new-pw&gt;\n</code></pre></li> <li>Rotate all OIDC client secrets (ThingsBoard, hawkBit, Grafana) \u2014 see IAM Architecture.</li> <li>Invalidate all active sessions in the <code>cdm</code> realm: Realm Settings \u2192 Sessions \u2192 Logout all.</li> <li>Audit the Keycloak event log for unauthorised actions: Events \u2192 Admin Events.</li> </ol>"},{"location":"use-cases/security-incident-response/#audit-trail","title":"Audit Trail","text":"<p>All security-relevant events are logged in:</p> Source How to Access step-ca certificate events <code>docker compose logs step-ca</code> Keycloak admin events Keycloak UI \u2192 Events \u2192 Admin Events ThingsBoard device events ThingsBoard UI \u2192 Device \u2192 Audit Log iot-bridge-api enrollment log <code>docker compose logs iot-bridge-api</code> WireGuard connection log <code>docker compose logs wireguard</code> <p>For production, forward all logs to a SIEM (e.g. Grafana Loki, OpenSearch, Splunk) for long-term retention and alerting.</p>"},{"location":"use-cases/troubleshooting/","title":"Troubleshooting","text":"<p>This page collects the most common operational problems and their solutions.</p>"},{"location":"use-cases/troubleshooting/#cloud-infrastructure","title":"Cloud Infrastructure","text":""},{"location":"use-cases/troubleshooting/#services-fail-to-start-port-already-in-use","title":"Services fail to start \u2014 \"port already in use\"","text":"<pre><code>Error: bind: address already in use (0.0.0.0:8080)\n</code></pre> <p>Fix: Stop the conflicting process or change the port mapping in <code>.env</code>:</p> <pre><code># Find the conflicting process\nlsof -i :8080\n# Or change the port in .env\nTB_HTTP_PORT=8081\n</code></pre>"},{"location":"use-cases/troubleshooting/#thingsboard-exits-immediately-after-start","title":"ThingsBoard exits immediately after start","text":"<p>Likely cause: PostgreSQL is not ready when ThingsBoard starts.</p> <p>Fix:</p> <pre><code>docker compose restart thingsboard\n# Wait 60\u201390 seconds \u2014 ThingsBoard is slow to initialise\ndocker compose ps\n</code></pre>"},{"location":"use-cases/troubleshooting/#step-ca-fails-with-certificate-already-exists","title":"step-ca fails with \"certificate already exists\"","text":"<p>Likely cause: The <code>step-ca-data</code> volume already contains a CA from a previous run with a different password.</p> <p>Fix (destructive \u2014 deletes the CA):</p> <pre><code>docker compose down\ndocker volume rm cloud-infrastructure_step-ca-data\ndocker compose up -d\n</code></pre> <p>Warning</p> <p>This invalidates all previously issued certificates. Re-enroll all devices.</p>"},{"location":"use-cases/troubleshooting/#iot-bridge-api-returns-503-on-enrollment","title":"iot-bridge-api returns <code>503</code> on enrollment","text":"<p>Causes:</p> <ol> <li>step-ca is not healthy.</li> <li><code>STEP_CA_URL</code> is wrong.</li> <li><code>STEP_CA_VERIFY_TLS=true</code> but the CA certificate is not trusted.</li> </ol> <p>Fix:</p> <pre><code># Check step-ca health\ncurl -k https://localhost:9000/health\n# Should return: {\"status\":\"ok\"}\n\n# Check env\ndocker compose exec iot-bridge-api env | grep STEP_CA\n</code></pre> <p>If <code>STEP_CA_VERIFY_TLS=true</code>, set it to <code>false</code> for local dev, or mount the Root CA cert and point <code>SSL_CERT_FILE</code> to it.</p>"},{"location":"use-cases/troubleshooting/#keycloak-returns-connection-refused-from-thingsboardhawkbit","title":"Keycloak returns <code>Connection refused</code> from ThingsBoard/hawkBit","text":"<p>Cause: Services use the internal Docker hostname <code>keycloak</code>, but the redirect URI was set to <code>localhost</code>.</p> <p>Fix: Update <code>Valid Redirect URIs</code> in each Keycloak client to use the internal hostname, and ensure <code>KC_HOSTNAME</code> in <code>.env</code> matches the externally reachable name.</p>"},{"location":"use-cases/troubleshooting/#device-stack","title":"Device Stack","text":""},{"location":"use-cases/troubleshooting/#bootstrap-exits-with-code-1-curl-6-could-not-resolve-host","title":"bootstrap exits with code 1 \u2014 \"curl: (6) Could not resolve host\"","text":"<p>Cause: <code>BRIDGE_API_URL</code> points to <code>localhost</code> which resolves to the container itself.</p> <p>Fix: Use the Docker host IP or the service name:</p> <pre><code># On Linux (Docker host IP from inside a container)\nBRIDGE_API_URL=http://172.17.0.1:8000\n# Or use host.docker.internal (macOS/Windows)\nBRIDGE_API_URL=http://host.docker.internal:8000\n</code></pre>"},{"location":"use-cases/troubleshooting/#bootstrap-is-not-idempotent-re-enrolls-on-every-start","title":"bootstrap is not idempotent \u2014 re-enrolls on every start","text":"<p>Cause: The <code>/certs/enrolled</code> flag file is not persisted (volume not mounted).</p> <p>Fix: Ensure the <code>device-certs</code> volume is declared and mounted in <code>docker-compose.yml</code>.</p>"},{"location":"use-cases/troubleshooting/#mqtt-client-cannot-connect-ssl-handshake-failed","title":"mqtt-client cannot connect \u2014 \"SSL handshake failed\"","text":"<p>Causes:</p> <ol> <li><code>ca-chain.crt</code> does not match the ThingsBoard MQTT TLS certificate.</li> <li>ThingsBoard MQTT TLS is not enabled.</li> </ol> <p>Fix:</p> <pre><code># Verify the cert chain\nopenssl verify -CAfile /certs/ca-chain.crt /certs/device.crt\n\n# Test the TLS connection manually\nopenssl s_client -connect localhost:8883 -CAfile /certs/ca-chain.crt\n</code></pre>"},{"location":"use-cases/troubleshooting/#wireguard-tunnel-not-establishing-rtnetlink-answers-operation-not-permitted","title":"WireGuard tunnel not establishing \u2014 \"RTNETLINK answers: Operation not permitted\"","text":"<p>Cause: WireGuard requires the <code>NET_ADMIN</code> Linux capability.</p> <p>Fix: Add capability to the wireguard-client service in <code>docker-compose.yml</code>:</p> <pre><code>cap_add:\n  - NET_ADMIN\n  - SYS_MODULE\n</code></pre>"},{"location":"use-cases/troubleshooting/#terminal-proxy","title":"Terminal Proxy","text":""},{"location":"use-cases/troubleshooting/#401-unauthorized-jwt-audience-invalid","title":"<code>401 Unauthorized</code> \u2014 \"jwt audience invalid\"","text":"<p>Fix: Ensure <code>KEYCLOAK_AUDIENCE</code> in terminal-proxy matches the <code>aud</code> claim in your Keycloak-issued JWT. Typically this is the client ID: <code>thingsboard</code>.</p>"},{"location":"use-cases/troubleshooting/#404-not-found-device-not-found-in-peers-db","title":"<code>404 Not Found</code> \u2014 \"device not found in peers DB\"","text":"<p>Fix: Verify the device is enrolled and <code>cdm_peers.json</code> contains the device:</p> <pre><code>docker compose exec terminal-proxy cat /wg-config/cdm_peers.json\n</code></pre> <p>If missing, re-run the device enrollment.</p>"},{"location":"use-cases/troubleshooting/#websocket-connects-but-terminal-immediately-closes","title":"WebSocket connects but terminal immediately closes","text":"<p>Cause: <code>ttyd</code> is not running on the device, or it is bound to the wrong interface.</p> <p>Fix: On the device:</p> <pre><code>systemctl status ttyd\n# If failed:\njournalctl -u ttyd -n 30\n# Check the bind address \u2014 must be the WireGuard interface IP, not 0.0.0.0\n</code></pre>"},{"location":"use-cases/troubleshooting/#getting-further-help","title":"Getting Further Help","text":"<ol> <li>Search the GitHub Discussions.</li> <li>Check the GitHub Issues for known bugs.</li> <li>If you believe you have found a new bug, open one using the bug report template.</li> </ol>"},{"location":"workflows/device-provisioning/","title":"Device Provisioning Workflow","text":"<p>This page is the complete operational runbook for the zero-touch device provisioning flow.</p>"},{"location":"workflows/device-provisioning/#overview","title":"Overview","text":"<p>Zero-touch provisioning means a device can be unboxed, powered on, and fully registered in the platform without any manual intervention. The process relies on:</p> <ul> <li>A pre-installed <code>enroll.sh</code> script (or <code>rauc-hawkbit-updater</code> equivalent) baked into the Yocto image.</li> <li>The device knowing only: the <code>iot-bridge-api</code> URL and the step-ca root CA fingerprint.</li> <li>No pre-shared passwords \u2014 only asymmetric cryptography.</li> </ul>"},{"location":"workflows/device-provisioning/#step-by-step-flow","title":"Step-by-Step Flow","text":""},{"location":"workflows/device-provisioning/#phase-1-factory-enrollment-first-boot","title":"Phase 1 \u2014 Factory Enrollment (first boot)","text":"<pre><code>[Device]                     [IoT Bridge API]             [step-ca]\n   \u2502                                \u2502                          \u2502\n   \u2502\u2500\u2500 generate EC key pair         \u2502                          \u2502\n   \u2502\u2500\u2500 generate CSR (CN=device-id)  \u2502                          \u2502\n   \u2502                                \u2502                          \u2502\n   \u2502\u2500\u2500 POST /devices/{id}/enroll \u2500\u2500\u25ba\u2502                          \u2502\n   \u2502         { csr_pem: \"...\" }     \u2502                          \u2502\n   \u2502                                \u2502\u2500\u2500 validate device-id     \u2502\n   \u2502                                \u2502\u2500\u2500 build OTT JWT          \u2502\n   \u2502                                \u2502\u2500\u2500 POST /1.0/sign \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n   \u2502                                \u2502\u25c4\u2500\u2500 signed cert \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n   \u2502                                \u2502\u2500\u2500 allocate WG IP         \u2502\n   \u2502                                \u2502\u2500\u2500 generate WG config     \u2502\n   \u2502\u25c4\u2500\u2500 { cert, ca_chain, wg } \u2500\u2500\u2500\u2500\u2500\u2502                          \u2502\n   \u2502                                \u2502                          \u2502\n   \u2502\u2500\u2500 save /certs/device.crt       \u2502                          \u2502\n   \u2502\u2500\u2500 save /certs/ca-chain.crt     \u2502                          \u2502\n   \u2502\u2500\u2500 save /certs/wg0.conf         \u2502                          \u2502\n   \u2502\u2500\u2500 write /certs/enrolled        \u2502  (idempotency flag)      \u2502\n</code></pre>"},{"location":"workflows/device-provisioning/#phase-2-first-mqtt-connection","title":"Phase 2 \u2014 First MQTT Connection","text":"<pre><code>[Device]                     [ThingsBoard]              [IoT Bridge API]\n   \u2502                                \u2502                          \u2502\n   \u2502\u2500\u2500 MQTT CONNECT (mTLS) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502                          \u2502\n   \u2502   (cert CN=device-id)          \u2502\u2500\u2500 verify cert chain      \u2502\n   \u2502                                \u2502   against step-ca Root CA\u2502\n   \u2502                                \u2502                          \u2502\n   \u2502                                \u2502\u2500\u2500 Rule Engine fires      \u2502\n   \u2502                                \u2502   POST_CONNECT event     \u2502\n   \u2502                                \u2502\u2500\u2500 POST /webhooks/thingsboard \u2500\u25ba\u2502\n   \u2502                                \u2502                          \u2502\u2500\u2500 create hawkBit target\n   \u2502                                \u2502                          \u2502\u2500\u2500 store WG IP in TB attributes\n   \u2502\u25c4\u2500\u2500 CONNACK \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                          \u2502\n</code></pre>"},{"location":"workflows/device-provisioning/#phase-3-device-registers-with-wireguard","title":"Phase 3 \u2014 Device Registers with WireGuard","text":"<pre><code>[Device]                     [WireGuard Server]\n   \u2502                                \u2502\n   \u2502\u2500\u2500 wg-quick up wg0 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n   \u2502   (uses /certs/wg0.conf)       \u2502\u2500\u2500 add peer (public key + allowed IPs)\n   \u2502\u25c4\u2500\u2500 tunnel established \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n   \u2502\u2500\u2500 now reachable at 10.8.0.x    \u2502\n</code></pre>"},{"location":"workflows/device-provisioning/#configuration-reference","title":"Configuration Reference","text":""},{"location":"workflows/device-provisioning/#iot-bridge-api-environment-variables","title":"iot-bridge-api Environment Variables","text":"Variable Description Example <code>STEP_CA_URL</code> step-ca API endpoint <code>https://step-ca:9000</code> <code>STEP_CA_FINGERPRINT</code> Root CA SHA-256 fingerprint <code>abc123...</code> <code>STEP_CA_PROVISIONER_NAME</code> JWK provisioner name <code>iot-bridge</code> <code>STEP_CA_PROVISIONER_PASSWORD</code> JWK provisioner decrypt password <code>...</code> <code>HAWKBIT_URL</code> hawkBit server URL <code>http://hawkbit:8090</code> <code>WG_SUBNET</code> WireGuard allocation subnet <code>10.8.0.0/24</code> <code>WG_SERVER_ENDPOINT</code> Public WireGuard endpoint <code>vpn.example.com:51820</code> <code>WG_SERVER_PUBLIC_KEY</code> WireGuard server public key <code>...</code>"},{"location":"workflows/device-provisioning/#re-enrollment","title":"Re-Enrollment","text":"<p>If a device loses its certificate (e.g. storage failure), delete the idempotency flag and re-run enrollment:</p> <pre><code>rm /certs/enrolled\n/opt/cdm/enroll.sh\n</code></pre> <p>The <code>device_id</code> is preserved; a new key pair and certificate are generated.</p>"},{"location":"workflows/device-provisioning/#decommissioning-a-device","title":"Decommissioning a Device","text":"<ol> <li>Revoke the device certificate in step-ca.</li> <li>Delete the device from ThingsBoard.</li> <li>Remove the device target from hawkBit.</li> <li>Remove the WireGuard peer from the server config:    <pre><code>wg set wg0 peer &lt;device-public-key&gt; remove\nwg-quick save wg0\n</code></pre></li> <li>Delete the device entry from <code>cdm_peers.json</code> (in the <code>wg-data</code> volume).</li> </ol>"},{"location":"workflows/device-provisioning/#troubleshooting","title":"Troubleshooting","text":"Problem Cause Fix 422 on POST /enroll Invalid CSR PEM Re-generate CSR with correct CN 503 on POST /enroll step-ca unreachable Check <code>STEP_CA_URL</code>, CA container health MQTT CONNREFUSED ThingsBoard not accepting mTLS Check device profile, CA chain loaded WireGuard not connecting Server public key mismatch Verify <code>WG_SERVER_PUBLIC_KEY</code> in <code>.env</code>"},{"location":"workflows/monitoring/","title":"Monitoring &amp; Telemetry Workflow","text":"<p>This page covers how device metrics flow from the edge to InfluxDB and how to use the Grafana dashboards.</p>"},{"location":"workflows/monitoring/#architecture","title":"Architecture","text":"<pre><code>Edge Device\n  \u251c\u2500\u2500 Telegraf  \u2500\u2500HTTP/InfluxDB Line Protocol\u2500\u2500\u25ba InfluxDB v2  \u2500\u2500\u25ba Grafana\n  \u2514\u2500\u2500 MQTT client \u2500\u2500MQTTS\u2500\u2500\u25ba ThingsBoard  \u2500\u2500Rule Engine\u2500\u2500\u25ba Alarms / Notifications\n</code></pre> <p>Principle: High-frequency, high-cardinality data (every 10 seconds for every device) goes to InfluxDB to avoid overwhelming ThingsBoard's PostgreSQL backend. Business-logic data (device state, alarms, OTA status) goes through ThingsBoard.</p>"},{"location":"workflows/monitoring/#telegraf-configuration","title":"Telegraf Configuration","text":"<p>The Telegraf config is at <code>device-stack/telegraf/telegraf.conf</code>. Key sections:</p>"},{"location":"workflows/monitoring/#inputs","title":"Inputs","text":"Plugin Metrics Interval <code>cpu</code> usage_user, usage_system, usage_idle 10s <code>mem</code> used_percent, available, free 10s <code>disk</code> used_percent, free, total 30s <code>net</code> bytes_sent, bytes_recv, drop_in, drop_out 10s <code>exec</code> Custom metrics from user scripts configurable <code>mqtt_consumer</code> Parses device MQTT messages as tags on message"},{"location":"workflows/monitoring/#output-influxdb-v2","title":"Output \u2014 InfluxDB v2","text":"<pre><code>[[outputs.influxdb_v2]]\n  urls = [\"http://influxdb:8086\"]\n  token = \"${INFLUXDB_TOKEN}\"\n  organization = \"cdm\"\n  bucket = \"device-telemetry\"\n  timeout = \"5s\"\n</code></pre>"},{"location":"workflows/monitoring/#adding-custom-metrics","title":"Adding Custom Metrics","text":"<p>To collect application-specific metrics, add an <code>exec</code> input:</p> <pre><code>[[inputs.exec]]\n  commands = [\"/opt/cdm/metrics/my-app-metrics.sh\"]\n  timeout = \"5s\"\n  data_format = \"influx\"\n  interval = \"30s\"\n</code></pre> <p>The script must output InfluxDB line protocol, e.g.: <pre><code>my_app,device_id=device-001 queue_depth=42i,error_rate=0.01 1700000000000000000\n</code></pre></p>"},{"location":"workflows/monitoring/#influxdb-buckets","title":"InfluxDB Buckets","text":"Bucket Retention Content <code>device-telemetry</code> 30 days All Telegraf metrics <code>device-events</code> 90 days Device state changes, OTA events (written by iot-bridge-api) <p>Buckets are created by <code>cloud-infrastructure/monitoring/influxdb/init-scripts/01-init-buckets.sh</code> on first start.</p>"},{"location":"workflows/monitoring/#grafana-dashboards","title":"Grafana Dashboards","text":"<p>Grafana is pre-provisioned with two dashboards:</p>"},{"location":"workflows/monitoring/#device-overview","title":"Device Overview","text":"<p>Shows for a selected device (variable <code>$device_id</code>):</p> <ul> <li>CPU usage (sparkline + gauge)</li> <li>Memory used %</li> <li>Disk used %</li> <li>Network throughput (bytes sent/recv)</li> <li>Top processes by CPU (from <code>exec</code> plugin)</li> </ul>"},{"location":"workflows/monitoring/#fleet-summary","title":"Fleet Summary","text":"<p>Shows across all devices:</p> <ul> <li>Online device count (last heartbeat &lt; 5 min)</li> <li>P50 / P95 CPU usage across fleet</li> <li>OTA success rate (from <code>device-events</code> bucket)</li> <li>Devices with disk &gt; 80%</li> </ul>"},{"location":"workflows/monitoring/#embedding-grafana-in-thingsboard","title":"Embedding Grafana in ThingsBoard","text":"<p>Grafana dashboards are embedded in ThingsBoard via iframes. To allow anonymous access from within the ThingsBoard UI:</p> <ol> <li>In Grafana, go to Configuration \u2192 Data Sources \u2192 InfluxDB and ensure the datasource is working.</li> <li>Enable anonymous access restricted to a specific organisation:    <pre><code>[auth.anonymous]\nenabled = true\norg_name = CDM\norg_role = Viewer\n</code></pre></li> <li>In ThingsBoard, add an iframe Widget and set the URL to:    <pre><code>http://grafana:3000/d/&lt;dashboard-uid&gt;/device-overview?orgId=1&amp;var-device_id=${entityId}\n</code></pre></li> </ol> <p>Production Security</p> <p>In production, restrict Grafana iframe access by placing it behind the WireGuard VPN or requiring Keycloak SSO. Do not expose Grafana with anonymous access to the public internet.</p>"},{"location":"workflows/monitoring/#alerting","title":"Alerting","text":"<p>ThingsBoard handles device-level alerting:</p> <ul> <li>High CPU (&gt; 90% for 5 min) \u2192 alarm in ThingsBoard \u2192 notification email/Slack</li> <li>Disk full (&gt; 95%) \u2192 critical alarm</li> <li>Device offline (no telemetry for 10 min) \u2192 <code>Inactive</code> state in ThingsBoard</li> </ul> <p>InfluxDB/Grafana handles fleet-level alerting:</p> <ul> <li>OTA error rate &gt; 5% \u2192 Grafana Alert \u2192 PagerDuty / email</li> <li>Average memory usage across fleet &gt; 80% \u2192 warning alert</li> </ul>"},{"location":"workflows/monitoring/#troubleshooting","title":"Troubleshooting","text":"Symptom Cause Fix No metrics in InfluxDB Telegraf can't reach InfluxDB Check <code>INFLUXDB_URL</code> and <code>INFLUXDB_TOKEN</code> in device <code>.env</code> Grafana shows \"No data\" Wrong bucket name or time range Verify bucket name matches <code>device-telemetry</code>; widen time range ThingsBoard telemetry stops MQTT client disconnected Check <code>mqtt-client</code> logs; verify cert validity Missing device in Fleet dashboard Telegraf tag <code>device_id</code> not set Add <code>[global_tags] device_id = \"${DEVICE_ID}\"</code> to <code>telegraf.conf</code>"},{"location":"workflows/ota-updates/","title":"OTA Update Workflow","text":"<p>This page covers the full OTA software lifecycle \u2014 from uploading a bundle to monitoring rollout success across the fleet.</p>"},{"location":"workflows/ota-updates/#components-involved","title":"Components Involved","text":"Component Role hawkBit Campaign management, artefact storage, DDI API rauc-hawkbit-updater Device-side DDI client; triggers RAUC install RAUC Executes A/B atomic OS or application updates ThingsBoard Receives OTA status telemetry from devices Grafana Visualises rollout success rates across the fleet"},{"location":"workflows/ota-updates/#update-types","title":"Update Types","text":"Type Description OS (rootfs) update Full Yocto rootfs image installed to inactive A/B slot; device reboots Application bundle RAUC bundle containing only app data; no reboot required (with RAUC app slots) Config update Small configuration artefact applied by a post-install hook"},{"location":"workflows/ota-updates/#full-rollout-procedure","title":"Full Rollout Procedure","text":""},{"location":"workflows/ota-updates/#1-build-and-sign-the-bundle","title":"1. Build and Sign the Bundle","text":"<p>On your build system (CI/CD):</p> <pre><code># Sign the RAUC bundle with the signing certificate\nrauc bundle \\\n  --cert rauc-signing.crt \\\n  --key rauc-signing.key \\\n  rootfs-1.1.0.tar.gz \\\n  cdm-os-1.1.0.raucb\n</code></pre>"},{"location":"workflows/ota-updates/#2-create-a-software-module-in-hawkbit","title":"2. Create a Software Module in hawkBit","text":"<pre><code># Via hawkBit REST API\ncurl -X POST http://localhost:8090/rest/v1/softwaremodules \\\n  -u admin:admin -H \"Content-Type: application/json\" \\\n  -d '{\"name\":\"cdm-os\",\"version\":\"1.1.0\",\"type\":\"os\"}'\n</code></pre> <p>Upload the bundle:</p> <pre><code>curl -X POST \"http://localhost:8090/rest/v1/softwaremodules/{id}/artifacts\" \\\n  -u admin:admin -F \"file=@cdm-os-1.1.0.raucb\"\n</code></pre>"},{"location":"workflows/ota-updates/#3-create-a-distribution-set","title":"3. Create a Distribution Set","text":"<pre><code>curl -X POST http://localhost:8090/rest/v1/distributionsets \\\n  -u admin:admin -H \"Content-Type: application/json\" \\\n  -d '{\"name\":\"cdm-release-1.1.0\",\"version\":\"1.1.0\",\"modules\":[{\"id\":&lt;module_id&gt;}]}'\n</code></pre>"},{"location":"workflows/ota-updates/#4-create-a-rollout-with-staged-groups","title":"4. Create a Rollout with Staged Groups","text":"<p>For a staged rollout (canary \u2192 10% \u2192 50% \u2192 100%):</p> <pre><code>curl -X POST http://localhost:8090/rest/v1/rollouts \\\n  -u admin:admin -H \"Content-Type: application/json\" \\\n  -d '{\n    \"name\": \"rollout-1.1.0\",\n    \"distributionSetId\": &lt;ds_id&gt;,\n    \"targetFilterQuery\": \"name==device-*\",\n    \"amountGroups\": 4,\n    \"successThreshold\": \"95\",\n    \"errorThreshold\": \"5\",\n    \"actionType\": \"soft\"\n  }'\n</code></pre> <p>Start the rollout:</p> <pre><code>curl -X POST \"http://localhost:8090/rest/v1/rollouts/{rollout_id}/start\" -u admin:admin\n</code></pre>"},{"location":"workflows/ota-updates/#5-device-receives-and-applies-the-update","title":"5. Device Receives and Applies the Update","text":"<p>The device polls hawkBit every <code>polling_sleep_time</code> seconds (configured in <code>rauc-hawkbit-updater.conf</code>):</p> <pre><code>[rauc-hawkbit-updater] Checking for deployment action...\n[rauc-hawkbit-updater] Action found \u2014 downloading artefact...\n[rauc-hawkbit-updater] Calling rauc install /tmp/cdm-os-1.1.0.raucb...\n[rauc-hawkbit-updater] RAUC install succeeded \u2014 marking boot slot B as active...\n[rauc-hawkbit-updater] Reporting success to hawkBit...\n[system] Rebooting into slot B...\n</code></pre>"},{"location":"workflows/ota-updates/#6-monitor-rollout-progress","title":"6. Monitor Rollout Progress","text":"<p>In the hawkBit UI (Rollout view), track:</p> <ul> <li>Scheduled \u2192 waiting for their group to activate</li> <li>Running \u2192 actively downloading/installing</li> <li>Finished: Success / Error \u2014 success rate must stay above <code>successThreshold</code></li> </ul> <p>In Grafana (OTA Rollout dashboard):</p> <ul> <li>Fleet-wide success rate over time</li> <li>P50/P95 download duration</li> <li>Error breakdown by error code</li> </ul>"},{"location":"workflows/ota-updates/#rollback","title":"Rollback","text":"<p>hawkBit does not automatically roll back devices (RAUC handles that locally). If a device fails to boot after an update:</p> <ol> <li>RAUC's boot loader integration (Barebox/U-Boot) automatically falls back to the previously active slot after <code>max_boot_attempts</code> failed boots.</li> <li>The device reports back to hawkBit with status <code>FAILURE</code>.</li> <li>The hawkBit rollout pauses if error rate exceeds <code>errorThreshold</code>.</li> </ol> <p>Manually trigger a rollback by assigning the previous Distribution Set to the affected device.</p>"},{"location":"workflows/ota-updates/#ota-status-telemetry","title":"OTA Status Telemetry","text":"<p>Devices publish OTA status to ThingsBoard after each update:</p> <pre><code>{\n  \"sw_version\": \"1.1.0\",\n  \"rauc_slot\": \"B\",\n  \"ota_status\": \"success\",\n  \"ota_error\": null\n}\n</code></pre> <p>The ThingsBoard rule chain can trigger an alarm if <code>ota_status</code> is <code>\"failure\"</code>.</p>"},{"location":"workflows/remote-access/","title":"Remote Access Workflow","text":"<p>This page explains how to open a secure browser-based terminal on a remote device.</p>"},{"location":"workflows/remote-access/#how-it-works","title":"How It Works","text":"<pre><code>Browser (ThingsBoard Terminal Widget)\n    \u2502\n    \u2502  WSS: wss://terminal-proxy:8888/terminal?deviceId=device-001&amp;token=&lt;JWT&gt;\n    \u25bc\nTerminal Proxy (Node.js)\n    \u251c\u2500\u2500 Validates Keycloak JWT (JWKS endpoint)\n    \u251c\u2500\u2500 Checks `preferred_username` claim has `cdm-operator` or `cdm-admin` role\n    \u251c\u2500\u2500 Looks up device-001 \u2192 WireGuard IP (10.8.0.2) from cdm_peers.json\n    \u2514\u2500\u2500 Proxies WebSocket to ws://10.8.0.2:7681\n                               \u2502\n                           ttyd on device\n                               \u2502\n                           /bin/bash (PTY)\n</code></pre> <p>The device is only reachable via the WireGuard VPN \u2014 it has no direct internet exposure.</p>"},{"location":"workflows/remote-access/#prerequisites","title":"Prerequisites","text":"<ul> <li>The device must be enrolled and connected to the WireGuard VPN.</li> <li><code>ttyd</code> must be running on the device (port 7681, bound to the WireGuard interface only).</li> <li>The terminal-proxy must be running and healthy.</li> <li>The operator must have a valid Keycloak JWT with role <code>cdm-operator</code> or <code>cdm-admin</code>.</li> </ul>"},{"location":"workflows/remote-access/#opening-a-terminal-from-thingsboard","title":"Opening a Terminal from ThingsBoard","text":"<ol> <li>In ThingsBoard, open the dashboard for your device.</li> <li>The Terminal custom widget is embedded in the dashboard.</li> <li>The widget automatically fetches the JWT from ThingsBoard's auth context.</li> <li>Click Connect \u2014 a terminal session opens in the browser.</li> </ol>"},{"location":"workflows/remote-access/#opening-a-terminal-directly-curl-wscat","title":"Opening a Terminal Directly (curl / wscat)","text":"<p>For testing or automation:</p> <pre><code># Install wscat\nnpm install -g wscat\n\n# Get a Keycloak token\nTOKEN=$(curl -s -X POST \\\n  http://localhost:8180/realms/cdm/protocol/openid-connect/token \\\n  -d \"grant_type=password&amp;client_id=thingsboard&amp;username=admin&amp;password=&lt;pw&gt;\" \\\n  | python3 -c \"import sys,json; print(json.load(sys.stdin)['access_token'])\")\n\n# Connect to the terminal proxy\nwscat --connect \"ws://localhost:8888/terminal?deviceId=device-001&amp;token=$TOKEN\"\n</code></pre>"},{"location":"workflows/remote-access/#ttyd-setup-on-a-real-device","title":"ttyd Setup on a Real Device","text":"<p>Install and configure ttyd so it only listens on the WireGuard interface:</p> <pre><code># On the device (run as root)\nbash /opt/cdm/terminal/setup.sh\n</code></pre> <p>The setup script:</p> <ol> <li>Installs <code>ttyd</code> from the system package manager.</li> <li>Creates <code>/etc/systemd/system/ttyd.service</code> bound to the <code>wg0</code> interface.</li> <li>Sets the credential: username <code>cdm</code>, password from <code>CDM_TTYD_PASSWORD</code> env var.</li> <li>Enables and starts the service.</li> </ol> <p>Security</p> <p>ttyd exposes a shell. Always: - Bind to the WireGuard interface only (never <code>0.0.0.0</code>). - Use a strong, unique password. - Consider disabling password auth and requiring the JWT-validated proxy.</p>"},{"location":"workflows/remote-access/#terminal-proxy-configuration","title":"Terminal Proxy Configuration","text":"Environment Variable Description Default <code>PORT</code> Proxy listen port <code>8888</code> <code>KEYCLOAK_JWKS_URI</code> Keycloak JWKS endpoint (required) <code>KEYCLOAK_AUDIENCE</code> Expected JWT <code>aud</code> claim <code>thingsboard</code> <code>REQUIRED_ROLE</code> JWT role required to connect <code>cdm-operator</code> <code>PEERS_DB_PATH</code> Path to <code>cdm_peers.json</code> <code>/wg-config/cdm_peers.json</code> <code>TTYD_PORT</code> ttyd port on devices <code>7681</code>"},{"location":"workflows/remote-access/#troubleshooting","title":"Troubleshooting","text":"Symptom Cause Fix <code>401 Unauthorized</code> in browser Token expired or wrong audience Re-login to ThingsBoard; check <code>KEYCLOAK_AUDIENCE</code> <code>404 Device not found</code> Device not in <code>cdm_peers.json</code> Re-enroll device; check <code>PEERS_DB_PATH</code> WebSocket connects but terminal is blank ttyd not running on device SSH in and check <code>systemctl status ttyd</code> Terminal disconnects after a few seconds WireGuard tunnel lost Check device WG status: <code>wg show</code>"}]}