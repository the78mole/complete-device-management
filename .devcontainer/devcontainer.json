{
  "name": "CDM Platform Dev",
  // Re-use whichever image the Codespace / devcontainer spins up;
  // adjust if you add a custom Dockerfile later.
  "image": "mcr.microsoft.com/devcontainers/base:ubuntu-24.04",

  // ── Port forwarding ────────────────────────────────────────────────────────
  // VS Code / Codespaces will automatically forward these ports and show them
  // in the Ports panel with the labels defined below.
  //
  // Port → Service mapping (both stacks share some port numbers):
  //   8888  – Caddy reverse proxy     (provider-stack + tenant-stack, main entry)
  //   8080  – Keycloak                (provider-stack + tenant-stack)
  //   9000  – step-ca PKI             (provider-stack + tenant-stack)
  //   8000  – IoT Bridge API          (provider-stack + tenant-stack, FastAPI)
  //   9090  – ThingsBoard UI          (tenant-stack, direct port — SPA limitation)
  //   8086  – InfluxDB / OAuth2 Proxy (provider-stack + tenant-stack, direct port)
  //   1883  – RabbitMQ MQTT plain     (provider-stack)
  //   5672  – RabbitMQ AMQP          (provider-stack)
  //   8883  – MQTT TLS               (provider-stack RabbitMQ + tenant-stack ThingsBoard)
  //   8090  – Terminal Proxy          (tenant-stack, WebSocket)
  "forwardPorts": [8888, 8080, 9000, 8000, 9090, 8086, 1883, 5672, 8883, 8090],

  "portsAttributes": {
    "8888": {
      "label": "CDM – Caddy (Main Entrypoint)",
      "onAutoForward": "openBrowser",
      "protocol": "http"
    },
    "8080": {
      "label": "Keycloak",
      "onAutoForward": "notify",
      "protocol": "http"
    },
    "9000": {
      "label": "step-ca PKI",
      "onAutoForward": "silent",
      "protocol": "https"
    },
    "8000": {
      "label": "IoT Bridge API (FastAPI)",
      "onAutoForward": "notify",
      "protocol": "http"
    },
    "9090": {
      "label": "ThingsBoard UI (tenant)",
      "onAutoForward": "notify",
      "protocol": "http"
    },
    "8086": {
      "label": "InfluxDB / OAuth2 Proxy",
      "onAutoForward": "notify",
      "protocol": "http"
    },
    "1883": {
      "label": "RabbitMQ MQTT (plain)",
      "onAutoForward": "silent"
    },
    "5672": {
      "label": "RabbitMQ AMQP",
      "onAutoForward": "silent"
    },
    "8883": {
      "label": "MQTT TLS (RabbitMQ / ThingsBoard)",
      "onAutoForward": "silent"
    },
    "8090": {
      "label": "Terminal Proxy (WebSocket, tenant)",
      "onAutoForward": "silent"
    }
  },

  // Make the main UI public in Codespaces so the landing page opens without
  // an additional authentication step. Adjust to "private" for sensitive envs.
  "otherPortsAttributes": {
    "onAutoForward": "silent"
  },

  // ── Features ──────────────────────────────────────────────────────────────
  // common-utils: creates a consistent non-root "vscode" user, fixes
  //   Git "dubious ownership" warnings, and installs basic shell tooling.
  // docker-outside-of-docker: mounts the host Docker socket and installs
  //   the Docker CLI + Compose plugin. Containers run as siblings on the
  //   host so all port bindings in docker-compose.yml work unchanged.
  "features": {
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": true,
      "configureZshAsDefaultShell": false,
      "installOhMyZsh": false,
      "upgradePackages": false,
      "username": "vscode",
      "userUid": "automatic",
      "userGid": "automatic"
    },
    "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {
      "moby": false,
      "installDockerBuildx": true,
      "dockerDashComposeVersion": "v2"
    },
    "ghcr.io/devcontainers/features/python:1": {}
  },

  // ── Environment ───────────────────────────────────────────────────────────
  // DOCKER_API_VERSION: pin the client to the host daemon's max supported API.
  // Without this, a newer Docker CLI (e.g. 1.52) will be rejected by an older
  // daemon (e.g. Engine 23.x, API 1.43) with "client version too new".
  // Adjust the value if the host daemon is upgraded.
  "remoteEnv": {
    "DOCKER_API_VERSION": "1.43"
  },

  // Fix Git "unsafe/dubious ownership" for the mounted workspace
  "postCreateCommand": "git config --global --add safe.directory ${containerWorkspaceFolder}",

  "remoteUser": "vscode",
  "customizations": {
    "vscode": {
      "extensions": [
        "ms-vscode.makefile-tools"
      ]
    }
  }
}
