# local.conf – CDM Yocto TPM build config for Raspberry Pi 4 (64-bit)

MACHINE = "raspberrypi4-64"

IMAGE_FSTYPES = "wic.bz2 wic.bmap"

# ── TPM SPI device tree overlay ───────────────────────────────────────────────
# Activates the SLB967x TPM on SPI0 CE1 (pin 26).
# The tpm-slb9670 overlay covers the full SLB967x family including SLB9672.
# SPI0_CE1 = GPIO7: change to ce0 (GPIO8, pin 24) if wiring uses CE0.
ENABLE_UART = "1"
RPI_EXTRA_CONFIG = '\
# CDM TPM: Infineon SLB9672 on SPI0 CE1\n\
dtoverlay=tpm-slb9670,ce1_pin=26\n\
'

# ── Package manager ───────────────────────────────────────────────────────────
PACKAGE_CLASSES = "package_ipk"

# ── Packages ──────────────────────────────────────────────────────────────────
# tpm2-tools   – tpm2_createprimary, tpm2_create, tpm2_evictcontrol, …
# tpm2-tss     – TCG TSS2 stack (tcsd / tss2 libraries)
# tpm2-abrmd   – Access Broker & Resource Manager daemon (tpm2-abrmd)
# tpm2-openssl – OpenSSL 3.x provider: allows `openssl … -provider tpm2`
# tpm2-pkcs11  – PKCS#11 backend for tpm2-tss (for mosquitto/libp11 path)
IMAGE_INSTALL:append = " \
    openssl \
    openssl-bin \
    curl \
    mosquitto-clients \
    bash \
    coreutils \
    tpm2-tools \
    tpm2-tss \
    tpm2-abrmd \
    tpm2-openssl \
    tpm2-pkcs11 \
    pkcs11-helper \
    libp11 \
    cdm-enroll-tpm \
"

BB_NUMBER_THREADS ?= "${@min(os.cpu_count(), 8)}"
PARALLEL_MAKE     ?= "-j ${@min(os.cpu_count(), 8)}"

LICENSE_FLAGS_ACCEPTED = "synaptics-killswitch commercial"
EXTRA_IMAGE_FEATURES += "ssh-server-openssh"
EXTRA_IMAGE_FEATURES += "debug-tweaks"

# Kernel config fragment for TPM SPI driver (applied by bbappend in meta-cdm-tpm)
KERNEL_FEATURES:append = " cfg/tpm-spi.scc"
