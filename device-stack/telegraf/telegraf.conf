# telegraf.conf – CDM Edge Device
#
# Sends high-frequency system metrics and MQTT-relayed application data
# directly to InfluxDB, bypassing ThingsBoard for time-series data.
#
# Environment variables (set in docker-compose.yml):
#   INFLUX_URL     – InfluxDB HTTP URL
#   INFLUX_TOKEN   – InfluxDB operator token
#   INFLUX_ORG     – InfluxDB organisation
#   INFLUX_BUCKET  – InfluxDB bucket
#   DEVICE_ID      – used as global tag

[global_tags]
  device_id = "$DEVICE_ID"
  component = "device"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "2s"
  flush_interval = "10s"
  flush_jitter = "5s"
  precision = ""
  quiet = false
  hostname = "$DEVICE_ID"
  omit_hostname = false

# ── Outputs ───────────────────────────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls          = ["$INFLUX_URL"]
  token         = "$INFLUX_TOKEN"
  organization  = "$INFLUX_ORG"
  bucket        = "$INFLUX_BUCKET"
  timeout       = "10s"
  # Retry on transient failures (cloud not yet ready)
  content_encoding = "gzip"

# ── System Metrics Inputs ─────────────────────────────────────────────────────

[[inputs.cpu]]
  # Sample all logical CPUs; report total too
  percpu          = true
  totalcpu        = true
  collect_cpu_time = false
  report_active   = false

[[inputs.mem]]
  # RAM utilisation

[[inputs.disk]]
  # Disk utilisation – monitor root and data partitions
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.diskio]]
  # Block device I/O stats

[[inputs.net]]
  # Network interface stats (bytes sent/received)
  ignore_protocol_stats = false

[[inputs.processes]]
  # Process counts by state

[[inputs.system]]
  # Load average, uptime

# ── MQTT Consumer (application telemetry) ────────────────────────────────────
# Subscribes to the device's own telemetry channel and forwards to InfluxDB.
# This lets application-level metrics (OTA status, sensor readings) flow to
# InfluxDB even when they were sent via MQTT to ThingsBoard.

[[inputs.mqtt_consumer]]
  servers    = ["tcp://host.docker.internal:1883"]
  topics     = ["v1/devices/me/telemetry"]
  qos        = 1
  username   = ""
  password   = ""
  client_id  = "telegraf-$DEVICE_ID"
  data_format = "json"
  name_override = "device_telemetry"
  tag_keys   = ["device_id", "ota_status"]

# ── Exec Input (RAUC slot status) ─────────────────────────────────────────────
# On real Yocto hardware, this runs `rauc status --output-format=json` to
# report the current A/B slot state.  In Docker simulation it returns a stub.

[[inputs.exec]]
  commands = [
    "sh -c \"echo '{\\\"booted_slot\\\":\\\"A\\\",\\\"rauc_status\\\":\\\"ok\\\"}'\"",
  ]
  timeout = "5s"
  data_format = "json"
  name_override = "rauc_status"
  interval = "60s"
