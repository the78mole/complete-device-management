# telegraf.conf – CDM Edge Device
#
# Subscribes to optional additional MQTT sensor data (local device sensors
# published to Tenant ThingsBoard MQTT) and forwards them to Tenant InfluxDB.
# Primary device metrics (CPU, RAM, OTA status, etc.) are sourced from
# ThingsBoard and hawkBit via the Tenant Telegraf pipeline – NOT collected
# directly from the device OS.
#
# Environment variables (set in docker-compose.yml):
#   INFLUX_URL       – Tenant InfluxDB HTTP URL (port 8086 direct)
#   INFLUX_TOKEN     – InfluxDB operator token
#   INFLUX_ORG       – InfluxDB organisation (= TENANT_ID in tenant-stack)
#   INFLUX_BUCKET    – InfluxDB bucket
#   DEVICE_ID        – used as global tag and MQTT client ID
#   TENANT_ID        – CDM Tenant ID; used as MQTT topic prefix for isolation
#   THINGSBOARD_HOST – Tenant ThingsBoard MQTT broker hostname (port 8883 direct)

[global_tags]
  device_id = "$DEVICE_ID"
  tenant_id = "$TENANT_ID"
  component = "device"

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "5s"
  flush_interval = "30s"
  flush_jitter = "5s"
  precision = ""
  quiet = false
  hostname = "$DEVICE_ID"
  omit_hostname = false

# ── Outputs ───────────────────────────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls          = ["$INFLUX_URL"]
  token         = "$INFLUX_TOKEN"
  organization  = "$INFLUX_ORG"
  bucket        = "$INFLUX_BUCKET"
  timeout       = "10s"
  content_encoding = "gzip"

# ── Optional MQTT Sensor Data ─────────────────────────────────────────────────
# Subscribes to the tenant- and device-scoped MQTT topic for any additional
# sensor readings published by local device applications (e.g. temperature
# sensors, vibration monitors, power meters) to Tenant ThingsBoard MQTT.
#
# Topic structure: cdm/<TENANT_ID>/<DEVICE_ID>/sensors
#   – The tenant prefix enforces Mandant isolation: a subscriber
#     authenticated for tenant A cannot receive data for tenant B.
#
# Devices publish to this topic using mTLS with their X.509 certificate
# signed by the Tenant Sub-CA during bootstrap enrollment.
# Tenant ThingsBoard MQTT broker on port 8883 enforces certificate validity.

[[inputs.mqtt_consumer]]
  servers     = ["ssl://$THINGSBOARD_HOST:8883"]
  topics      = ["cdm/$TENANT_ID/$DEVICE_ID/sensors"]
  qos         = 1
  client_id   = "telegraf-$DEVICE_ID"
  data_format = "json"
  name_override = "device_sensors"
  tag_keys    = ["sensor_id", "sensor_type"]

  # mTLS – device certificate issued by step-ca during bootstrap
  tls_ca   = "/certs/ca-chain.pem"
  tls_cert = "/certs/device.pem"
  tls_key  = "/certs/device-key.pem"
