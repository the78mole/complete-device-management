# telegraf.conf – CDM Edge Device
#
# Subscribes to optional additional MQTT sensor data and forwards it to
# InfluxDB.  Primary device metrics (CPU, RAM, OTA status, etc.) are sourced
# from ThingsBoard and hawkBit via the cloud-side Telegraf and the
# iot-bridge-api telemetry webhook – NOT collected directly from the device OS.
#
# Environment variables (set in docker-compose.yml):
#   INFLUX_URL       – InfluxDB HTTP URL
#   INFLUX_TOKEN     – InfluxDB operator token
#   INFLUX_ORG       – InfluxDB organisation
#   INFLUX_BUCKET    – InfluxDB bucket
#   DEVICE_ID        – used as global tag
#   HAWKBIT_TENANT   – tenant identifier (used in MQTT topic for isolation)
#   THINGSBOARD_HOST – ThingsBoard MQTT broker hostname

[global_tags]
  device_id = "$DEVICE_ID"
  tenant_id = "$HAWKBIT_TENANT"
  component = "device"

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "5s"
  flush_interval = "30s"
  flush_jitter = "5s"
  precision = ""
  quiet = false
  hostname = "$DEVICE_ID"
  omit_hostname = false

# ── Outputs ───────────────────────────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls          = ["$INFLUX_URL"]
  token         = "$INFLUX_TOKEN"
  organization  = "$INFLUX_ORG"
  bucket        = "$INFLUX_BUCKET"
  timeout       = "10s"
  content_encoding = "gzip"

# ── Optional MQTT Sensor Data ─────────────────────────────────────────────────
# Subscribes to the tenant- and device-scoped MQTT topic for any additional
# sensor readings published by local device applications (e.g. temperature
# sensors, vibration monitors, power meters).
#
# Topic structure: cdm/<HAWKBIT_TENANT>/<DEVICE_ID>/sensors
#   – The tenant prefix enforces Mandanten-Isolation: a subscriber
#     authenticated for tenant A cannot receive data for tenant B.
#
# Devices publish to this topic using mTLS with their X.509 certificate.
# The ThingsBoard MQTT broker on port 8883 enforces certificate validity.

[[inputs.mqtt_consumer]]
  servers     = ["ssl://$THINGSBOARD_HOST:8883"]
  topics      = ["cdm/$HAWKBIT_TENANT/$DEVICE_ID/sensors"]
  qos         = 1
  client_id   = "telegraf-$DEVICE_ID"
  data_format = "json"
  name_override = "device_sensors"
  tag_keys    = ["sensor_id", "sensor_type"]

  # mTLS – device certificate issued by step-ca during bootstrap
  tls_ca   = "/certs/ca-chain.pem"
  tls_cert = "/certs/device.pem"
  tls_key  = "/certs/device-key.pem"
