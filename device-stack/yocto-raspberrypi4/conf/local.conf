# local.conf – CDM Yocto build configuration for Raspberry Pi 4 (64-bit)
#
# This file is copied into $BUILD_DIR/conf/local.conf by docker-entrypoint.sh.
# DL_DIR and SSTATE_DIR are injected at runtime from the mounted volumes.

# ── Target machine ────────────────────────────────────────────────────────────
MACHINE = "raspberrypi4-64"

# ── Image format: WIC (partitioned SD-card image) ─────────────────────────────
IMAGE_FSTYPES = "wic.bz2 wic.bmap"

# Enable UART; allows serial console on RPi 4 GPIO pins
ENABLE_UART = "1"

# ── Package manager ───────────────────────────────────────────────────────────
PACKAGE_CLASSES = "package_ipk"

# ── Extra packages installed into the image ───────────────────────────────────
# Required for CDM enrollment and mTLS MQTT test
IMAGE_INSTALL:append = " \
    openssl \
    openssl-bin \
    curl \
    mosquitto-clients \
    bash \
    coreutils \
    cdm-enroll \
"

# ── Parallel build tuning ─────────────────────────────────────────────────────
BB_NUMBER_THREADS ?= "${@min(os.cpu_count(), 8)}"
PARALLEL_MAKE     ?= "-j ${@min(os.cpu_count(), 8)}"

# ── Misc ──────────────────────────────────────────────────────────────────────
# Accept commercial licenses (required for some RPi firmware blobs)
LICENSE_FLAGS_ACCEPTED = "synaptics-killswitch commercial"

# SSH server for remote access during development
EXTRA_IMAGE_FEATURES += "ssh-server-openssh"

# Useful debug tools (remove for production)
EXTRA_IMAGE_FEATURES += "debug-tweaks"
